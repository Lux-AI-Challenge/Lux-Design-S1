(()=>{var t,e,n,r={2791:function(t,e,n){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});const i=n(2880),s=r(n(1058));let o=new(n(5139).LuxDesign)("lux_ai_2021"),a=i.create(o,{name:"Lux AI 2021",loggingLevel:i.Logger.LEVEL.NONE,activateStation:!1,observe:!1});const u=s.default.createInterface({input:process.stdin,output:process.stdout,terminal:!1});(async()=>{let t=null;for await(const e of u){const n=JSON.parse(e);if(n.type&&"start"===n.type){const e={detached:!0,agentOptions:{detached:!0},storeReplay:!1,storeErrorLogs:!1,mapType:n.config.mapType,parameters:{MAX_DAYS:n.config.episodeSteps-2}};t=await a.createMatch([{file:"blank",name:"bot1"},{file:"blank",name:"bot2"}],e),t.agents.forEach(((t,e)=>{console.log(JSON.stringify(t.messages)),t.messages=[]}))}else if(n.length){let e=[];[0,1].forEach((t=>{if(n[t].action){let r=n[t].action.map((e=>({agentID:t,command:e})));e.push(...r)}}));const r=await t.step(e);t.agents.forEach((t=>{console.log(JSON.stringify(t.messages)),t.messages=[]}));const i=t.state;console.log(JSON.stringify({status:r,turn:i.game.state.turn,max:t.configs.parameters.MAX_DAYS}))}}})()},2605:function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),s=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},o=this&&this.__generator||function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},a=this&&this.__spreadArrays||function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),i=0;for(e=0;e<n;e++)for(var s=arguments[e],o=0,a=s.length;o<a;o++,i++)r[i]=s[o];return r},u=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});var c=n(3129),l=u(n(5622)),h=u(n(5747)),f=u(n(1438)),d=n(8579),p=n(7792),m=n(2943),g=n(5660),y=n(8234),v=n(2413),_=n(8614),b=n(1861),w=u(n(806)),S=u(n(6354)),E=n(6046),M=JSON.stringify(S.default),P="/code",I=function(t){function e(n,r,i){void 0===i&&(i={});var s=t.call(this)||this;if(s.id=0,s.tournamentID=null,s.cmd=null,s.options=y.deepCopy(e.OptionDefaults),s._buffer=[],s.memoryWatchInterval=null,s.process=null,s.container=null,s.streams={in:null,out:null,err:null},s.status=e.Status.UNINITIALIZED,s.currentMoveCommands=[],s._currentMoveResolve=E.noop,s.agentTimeStep=0,s._clearTimer=E.noop,s.errorLogWriteStream=null,s.log=new d.Logger,s.logkey=null,s.allowedToSendCommands=!0,s.version=0,s._logsize=0,s._trimmed=!1,s.messages=[],s.creationDate=new Date,s.options=m.deepMerge(s.options,y.deepCopy(r)),s.log.level=s.options.loggingLevel,!s.options.detached){s.ext=l.default.extname(n),i[s.ext]&&(s.options=m.deepMerge(s.options,y.deepCopy(i[s.ext])));var o=n.split("/");if(s.cwd=o.slice(0,-1).join("/"),s.src=o.slice(-1).join("/"),s.srcNoExt=s.src.slice(0,-s.ext.length),!h.default.existsSync(s.cwd))throw new p.AgentDirectoryError(s.cwd+" directory does not exist, check if directory provided through the file is correct",s.id);if(!h.default.existsSync(n))throw new p.AgentFileError(n+" does not exist, check if file path provided is correct",s.id);switch(s.file=n,s.ext){case".py":s.cmd="python";break;case".js":case".ts":s.cmd="node";break;case".java":s.cmd="java";break;case".php":s.cmd="php";break;case".c":case".cpp":case".go":s.cmd=""}}if(null===s.options.id)throw new p.AgentMissingIDError("No id provided for agent using "+n,s.id);return s.id=r.id,s.options.name?s.name=s.options.name:s.name="agent_"+s.id,s.options.tournamentID&&(s.tournamentID=r.tournamentID,s.name=s.tournamentID.name),s.log.system("Created agent: "+s.name),s.status=e.Status.READY,s}return i(e,t),e.prototype.setupContainer=function(t,e,n){return s(this,void 0,void 0,(function(){var r,i;return o(this,(function(s){switch(s.label){case 0:return r={SecurityOpt:["seccomp="+M]},n.memory.active&&(r.Memory=n.memory.limit),[4,e.createContainer({Image:this.options.image,name:t,OpenStdin:!0,StdinOnce:!0,HostConfig:r})];case 1:return i=s.sent(),this.log.system("Created container "+t),this.container=i,[4,i.start()];case 2:return s.sent(),this.log.system("Started container "+t),[4,g.dockerCopy(this.cwd+"/.",t,"/code")];case 3:return s.sent(),this.log.system("Copied bot into container "+t),[2]}}))}))},e.prototype._install=function(t,e,n){var r=this;return new Promise((function(i,a){return s(r,void 0,void 0,(function(){var r,u,f,d,m,g,y,v,_,b=this;return o(this,(function(w){switch(w.label){case 0:if(!h.default.existsSync(l.default.join(this.cwd,"install.sh")))return[3,9];if(r=void 0,u=void 0,f=setTimeout((function(){var t="Agent went over install time during the install stage\n";b.writeToErrorLog(t),a(new p.AgentInstallTimeoutError(t,b.id))}),this.options.maxInstallTime),d=[],m=function(t){if(clearTimeout(f),0===t)i();else{var e="A install time error occured. Install step for agent "+b.id+" exited with code: "+t+"; Installing "+l.default.join(b.cwd,"install.sh")+"; Install Output:\n"+d.join("");137===t&&(e+="\nAgent likely ran out of memory, exceeded "+n.memory.limit/1e6+" MB"),b.writeToErrorLog(e+"\n"),a(new p.AgentInstallError(e,b.id))}},g=function(t){clearTimeout(f),a(t)},!this.options.secureMode)return[3,7];w.label=1;case 1:return w.trys.push([1,5,,6]),[4,this.container.exec({Cmd:["/bin/sh","-c","chmod u+x install.sh"],WorkingDir:P})];case 2:return[4,w.sent().start({})];case 3:return w.sent(),[4,this.containerSpawn(l.default.join(P,"install.sh"))];case 4:return y=w.sent(),u=y.err,r=y.out,y.stream.on("end",(function(){return s(b,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return[4,y.exec.inspect()];case 1:return t=e.sent(),m(t.ExitCode),[2]}}))}))})),y.stream.on("error",(function(t){g(t)})),[3,6];case 5:return v=w.sent(),g(v),[2];case 6:return[3,8];case 7:(_=c.spawn("sh",["install.sh"],{cwd:this.cwd})).on("error",(function(t){g(t)})),_.on("close",(function(t){m(t)})),u=_.stderr,r=_.stdout,w.label=8;case 8:return r.on("data",(function(t){d.push(t)})),u.on("data",(function(t){d.push(t)})),t&&u.pipe(t,{end:!1}),e&&r.pipe(e,{end:!1}),[3,10];case 9:i(),w.label=10;case 10:return[2]}}))}))}))},e.prototype._compile=function(t,e,n){return s(this,void 0,void 0,(function(){var r=this;return o(this,(function(i){return[2,new Promise((function(i,u){return s(r,void 0,void 0,(function(){var r,c,l,h,f,d,m,g,y,v,_=this;return o(this,(function(w){switch(w.label){case 0:return h=setTimeout((function(){var t="Agent went over compile time during the compile stage\n";_.writeToErrorLog(t),u(new p.AgentCompileTimeoutError(t,_.id))}),this.options.maxCompileTime),this.options.compileCommands[this.ext]?(f=this.options.compileCommands[this.ext][0],d=this.options.compileCommands[this.ext].slice(1),[4,this._spawnCompileProcess(f,a(d,[this.src]))]):[3,2];case 1:return r=w.sent(),[3,15];case 2:switch(this.ext){case".py":case".php":case".js":return[3,3];case".ts":return[3,4];case".go":return[3,6];case".cpp":return[3,8];case".c":return[3,10];case".java":return[3,12]}return[3,14];case 3:return clearTimeout(h),i(),[2];case 4:return[4,this._spawnCompileProcess("tsc",[])];case 5:return r=w.sent(),[3,15];case 6:return[4,this._spawnCompileProcess("go",["build","-o",this.srcNoExt+".out",this.src])];case 7:return r=w.sent(),[3,15];case 8:return[4,this._spawnCompileProcess("g++",["-std=c++11","-O3","-o",this.srcNoExt+".out",this.src])];case 9:return r=w.sent(),[3,15];case 10:return[4,this._spawnCompileProcess("gcc",["-O3","-o",this.srcNoExt+".out",this.src])];case 11:return r=w.sent(),[3,15];case 12:return[4,this._spawnCompileProcess("javac",[this.src])];case 13:return r=w.sent(),[3,15];case 14:return u(new p.NotSupportedError("Language with extension "+this.ext+" is not supported at the moment")),[3,15];case 15:return m=[],g=function(t){if(clearTimeout(h),0===t)i();else{var e="A compile time error occured. Compile step for agent "+_.id+" exited with code: "+t+"; Compiling "+_.file+"; Compile Output:\n"+m.join("");137===t&&(e+="\nAgent likely ran out of memory, exceeded "+n.memory.limit/1e6+" MB"),_.writeToErrorLog(e+"\n"),u(new p.AgentCompileError(e,_.id))}},y=function(t){clearTimeout(h),u(t)},b.isChildProcess(r)?(c=r.stdout,l=r.stderr,r.on("error",(function(t){y(t)})),r.on("close",(function(t){g(t)}))):(c=r.out,l=r.err,v=r.exec,r.stream.on("error",(function(t){y(t)})),r.stream.on("end",(function(){return s(_,void 0,void 0,(function(){var t;return o(this,(function(e){switch(e.label){case 0:return[4,v.inspect()];case 1:return t=e.sent(),g(t.ExitCode),[2]}}))}))}))),c.on("data",(function(t){m.push(t)})),l.on("data",(function(t){m.push(t)})),t&&l.pipe(t,{end:!1}),e&&c.pipe(e,{end:!1}),[2]}}))}))}))]}))}))},e.prototype._spawnCompileProcess=function(t,e){return s(this,void 0,void 0,(function(){var n=this;return o(this,(function(r){return[2,new Promise((function(r,i){n.options.secureMode?n.containerSpawn(t+" "+e.join(" "),P).then(r).catch(i):r(c.spawn(t,a(e),{cwd:n.cwd}).on("error",(function(t){i(t)})))}))]}))}))},e.prototype.containerSpawn=function(t,e){return void 0===e&&(e="/"),s(this,void 0,void 0,(function(){var n,r,i,s,a;return o(this,(function(o){switch(o.label){case 0:return[4,this.container.exec({Cmd:["/bin/sh","-c",t],AttachStdin:!0,AttachStdout:!0,AttachStderr:!0,WorkingDir:e})];case 1:return[4,(n=o.sent()).start({stdin:!0,hijack:!0})];case 2:return r=o.sent(),i=new v.Stream.PassThrough,s=new v.Stream.PassThrough,a=new v.Stream.PassThrough,i.pipe(r),this.container.modem.demuxStream(r,s,a),[2,{in:i,out:s,err:a,stream:r,exec:n}]}}))}))},e.prototype._spawn=function(){return s(this,void 0,void 0,(function(){return o(this,(function(t){if(this.options.runCommands[this.ext])return[2,this._spawnProcess(this.options.runCommands[this.ext][0],a(this.options.runCommands[this.ext].slice(1),[this.src]))];switch(this.ext){case".py":case".js":case".php":return[2,this._spawnProcess(this.cmd,[this.src])];case".ts":return[2,this._spawnProcess(this.cmd,[this.srcNoExt+".js"])];case".java":return[2,this._spawnProcess(this.cmd,[this.srcNoExt])];case".c":case".cpp":case".go":return[2,this._spawnProcess("./"+this.srcNoExt+".out",[])];default:throw new p.NotSupportedError("Language with extension "+this.ext+" is not supported yet")}return[2]}))}))},e.prototype._spawnProcess=function(t,e){var n=this;return new Promise((function(r,i){n.options.secureMode?n.containerSpawn(t+" "+e.join(" "),P).then(r).catch(i):r(c.spawn(t,e,{cwd:n.cwd,detached:!1}).on("error",(function(t){i(t)})))}))},e.prototype.stop=function(){return s(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return this.isTerminated()?[3,4]:this.options.secureMode?[4,this.container.pause()]:[3,2];case 1:return t.sent(),[3,3];case 2:this.process.kill("SIGSTOP"),t.label=3;case 3:this.status=e.Status.STOPPED,t.label=4;case 4:return[2]}}))}))},e.prototype.resume=function(){return s(this,void 0,void 0,(function(){return o(this,(function(t){return this.isTerminated()||(this._allowCommands(),this.options.secureMode||this.process.kill("SIGCONT"),this.status=e.Status.RUNNING),[2]}))}))},e.prototype.timeout=function(){this.writeToErrorLog("Agent timed out"),this.emit(e.AGENT_EVENTS.TIMEOUT)},e.prototype.overMemory=function(){this.writeToErrorLog("Agent exceeded memory limit"),this.emit(e.AGENT_EVENTS.EXCEED_MEMORY_LIMIT)},e.prototype.inputDestroyed=function(){return this.streams.in.destroyed},e.prototype.write=function(t,e){return this.options.detached?(this.messages.push(t),process.nextTick(e),!0):!!this.streams.in.write(t)&&(process.nextTick(e),!0)},e.prototype.writeToErrorLog=function(t){this.errorLogWriteStream&&(this._logsize+=t.length,this.errorLogWriteStream.write(t))},e.prototype._getProcess=function(){return this.process},e.prototype._storeProcess=function(t){this.process=t},e.prototype.isTerminated=function(){return this.status===e.Status.KILLED},e.prototype._terminate=function(){var t=this;return this.status=e.Status.KILLED,new Promise((function(e,n){return s(t,void 0,void 0,(function(){var t,r,i=this;return o(this,(function(s){switch(s.label){case 0:if(!this.options.secureMode)return[3,10];if(!this.container)return[3,8];s.label=1;case 1:return s.trys.push([1,6,,7]),[4,this.container.inspect()];case 2:return t=s.sent(),this._clearTimer(),clearInterval(this.memoryWatchInterval),t.State.Running?[4,this.container.kill()]:[3,5];case 3:return s.sent(),[4,this.container.remove()];case 4:s.sent(),s.label=5;case 5:return e(),[3,7];case 6:return 409!==(r=s.sent()).statusCode&&"no such container"!==r.reason?n(r):e(),[3,7];case 7:return[3,9];case 8:e(),s.label=9;case 9:return[3,11];case 10:this.process?f.default(this.process.pid,"SIGKILL",(function(t){i._clearTimer(),clearInterval(i.memoryWatchInterval),t?n(t):e()})):e(),s.label=11;case 11:return[2]}}))}))}))},e.prototype._disallowCommands=function(){this.allowedToSendCommands=!1},e.prototype._allowCommands=function(){this.allowedToSendCommands=!0},e.prototype.isAllowedToSendCommands=function(){return this.allowedToSendCommands},e.prototype._setTimeout=function(t,e){for(var n=[],r=2;r<arguments.length;r++)n[r-2]=arguments[r];var i=setTimeout((function(){t.apply(void 0,n)}),e);this._clearTimer=function(){clearTimeout(i)}},e.prototype._finishMove=function(){return s(this,void 0,void 0,(function(){return o(this,(function(t){return this._clearTimer(),this._currentMoveResolve(),this.options.secureMode||this.process.kill("SIGSTOP"),this._disallowCommands(),[2]}))}))},e.prototype._setupMove=function(){var t=this;this.allowedToSendCommands=!0,this.agentTimeStep++,this.currentMoveCommands=[],this._currentMovePromise=new Promise((function(e,n){t._currentMoveResolve=e,t._currentMoveReject=n}))},e.prototype._setupMemoryWatcher=function(t){var e=this,n=function(){g.processIsRunning(e.process.pid)&&w.default(e.process.pid,{maxage:0,usePs:t.memory.usePs}).then((function(n){n.memory>t.memory.limit&&e.overMemory()})).catch((function(t){e.log.warn(t)}))};n(),this.memoryWatchInterval=setInterval(n,t.memory.checkRate)},e.generateAgents=function(t,n,r,i){if(void 0===r&&(r={}),void 0===i&&(i=[]),0===t.length)throw new p.AgentFileError("No files provided to generate agents with!",-1);var s=[];return b.AgentClassTypeGuards.isGenerationMetaData_FilesOnly(t)?t.forEach((function(t,o){var a=y.deepCopy(n);(a=m.deepMerge(a,y.deepCopy(i[o]?i[o]:{}))).id=o,s.push(new e(t,a,r))})):b.AgentClassTypeGuards.isGenerationMetaData_CreateMatch(t)?t.forEach((function(t,o){var a=y.deepCopy(n);(a=m.deepMerge(a,y.deepCopy(i[o]?i[o]:{}))).id=o,a.name=t.name,s.push(new e(t.file,a,r))})):t.forEach((function(t,o){var a=y.deepCopy(n);(a=m.deepMerge(a,y.deepCopy(i[o]?i[o]:{}))).id=o,a.tournamentID=t.tournamentID;var u=new e(t.file,a,r);u.version=t.version,s.push(u)})),s},e.prototype.getAgentErrorLogFilename=function(){return"agent_"+this.id+".log"},e}(_.EventEmitter);e.Agent=I,function(t){var e,n;(n=t.Status||(t.Status={})).UNINITIALIZED="uninitialized",n.READY="ready",n.RUNNING="running",n.CRASHED="crashed",n.KILLED="killed",n.STOPPED="stopped",(e=t.AGENT_EVENTS||(t.AGENT_EVENTS={})).EXCEED_MEMORY_LIMIT="exceedMemoryLimit",e.TIMEOUT="timeout",e.CLOSE="close",t.OptionDefaults={secureMode:!1,loggingLevel:d.Logger.LEVEL.INFO,id:null,tournamentID:null,name:null,maxInstallTime:3e5,maxCompileTime:6e4,runCommands:{},compileCommands:{},image:"docker.io/stonezt2000/dimensions_langs",useCachedBotFile:!1,logLimit:1e5,detached:!1}}(I=e.Agent||(e.Agent={})),e.Agent=I},2602:function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),s=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},o=this&&this.__generator||function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};Object.defineProperty(e,"__esModule",{value:!0});var a=n(2943),u=n(8234),c=n(8579),l=function(){function t(t,n){void 0===n&&(n={}),this.name=t,this.log=new c.Logger,this.designOptions=u.deepCopy(e.DefaultDesignOptions),a.deepMerge(this.designOptions,n),this.log.detail("Design + MatchEngine Options",this.designOptions),this.log.level=c.Logger.LEVEL.INFO,this.log.system("Initialized Design: "+this.name)}return t.prototype.setLogLevel=function(t){this.log.level=t},t.prototype.getDesignOptions=function(){return this.designOptions},t.createCustom=function(t,e){return new h(t,e)},t}();e.Design=l;var h=function(t){function e(e,n){return n.active=!0,t.call(this,e,{override:n})||this}return i(e,t),e.prototype.initialize=function(t){return s(this,void 0,void 0,(function(){return o(this,(function(e){return t.state={matchOutput:[]},t.results=[],[2]}))}))},e.prototype.update=function(){return s(this,void 0,void 0,(function(){return o(this,(function(t){return[2]}))}))},e.prototype.getResults=function(t){return s(this,void 0,void 0,(function(){return o(this,(function(e){return[2,t.results]}))}))},e}(l);e.DefaultDesignOptions={override:{active:!1,command:"echo NO COMMAND PROVIDED",conclude_command:"D_MATCH_FINISHED",arguments:[],timeout:6e5,resultHandler:null}}},8389:function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},i=this&&this.__generator||function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};Object.defineProperty(e,"__esModule",{value:!0});var s,o,a=n(2943),u=n(6046),c=n(8234),l=n(8579),h=n(578),f=n(1850),d=n(7792),p=n(5318),m=n(3892),g=n(5747),y=n(1861);!function(t){t.NONE="none",t.MONGO="mongo",t.FIRESTORE="firestore"}(s=e.DatabaseType||(e.DatabaseType={})),function(t){t.NONE="none",t.GCLOUD="gcloud",t.FS="fs-storage"}(o=e.StorageType||(e.StorageType={}));var v=function(){function t(e,n){var u=this;void 0===n&&(n={}),this.design=e,this.matches=new Map,this.tournaments=new Map,this.log=new l.Logger,this.statistics={tournamentsCreated:0,matchesCreated:0},this.configs={name:"",activateStation:!0,observe:!0,loggingLevel:l.Logger.LEVEL.INFO,defaultMatchConfigs:{secureMode:!1},secureMode:!1,backingDatabase:s.NONE,backingStorage:o.NONE,id:"oLBptg",stationConfigs:{}},this.cleaningUp=null,this.configs=a.deepMerge(this.configs,n),n.id?this.id=n.id:this.id=t.genDimensionID(),this.log.level=this.configs.loggingLevel,void 0===this.configs.stationConfigs.loggingLevel&&(this.configs.stationConfigs.loggingLevel=this.configs.loggingLevel),!0===this.configs.activateStation&&null==t.Station&&(t.Station=new f.Station("Station",[],this.configs.stationConfigs)),this.configs.defaultMatchConfigs.loggingLevel=this.configs.loggingLevel,this.design.setLogLevel(this.configs.loggingLevel),this.configs.name?this.name=this.configs.name:this.name="dimension_"+this.id,this.log.identifier=this.name+" Log",this.configs.secureMode?this.setupSecurity():this.log.warn("WARNING: Running in non-secure mode. You will not be protected against malicious bots"),this.configs.defaultMatchConfigs.secureMode=this.configs.secureMode,process.on("exit",(function(){return r(u,void 0,void 0,(function(){var t;return i(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.cleanup()];case 1:return e.sent(),[3,3];case 2:return t=e.sent(),console.error(t),[3,3];case 3:return process.exit(),[2]}}))}))})),process.on("SIGINT",(function(){return r(u,void 0,void 0,(function(){var t;return i(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,this.cleanup()];case 1:return e.sent(),[3,3];case 2:return t=e.sent(),console.error(t),[3,3];case 3:return process.exit(),[2]}}))}))})),!0===this.configs.observe&&null!=t.Station&&t.Station.observe(this),this.log.info("Created Dimension - ID: "+this.id+", Name: "+this.name),this.log.detail("Dimension Configs",this.configs),g.existsSync(f.BOT_DIR)||g.mkdirSync(f.BOT_DIR,{recursive:!0})}return t.prototype.createMatch=function(t,e){return r(this,void 0,void 0,(function(){var n,r;return i(this,(function(i){switch(i.label){case 0:if(!t.length)throw new d.MissingFilesError("No files provided for match");return n=c.deepCopy(this.configs.defaultMatchConfigs),n=a.deepMerge(n,e),y.AgentClassTypeGuards.isGenerationMetaData_FilesOnly(t),r=new h.Match(this.design,t,n,this),this.statistics.matchesCreated++,this.matches.set(r.id,r),[4,r.initialize()];case 1:return i.sent(),[2,r]}}))}))},t.prototype.runMatch=function(t,e){return r(this,void 0,void 0,(function(){var n,r;return i(this,(function(i){switch(i.label){case 0:return[4,this.createMatch(t,e)];case 1:return[4,(n=i.sent()).run()];case 2:return r=i.sent(),this.hasDatabase()&&this.databasePlugin.configs.saveMatches&&this.databasePlugin.storeMatch(n,this.id),[2,r]}}))}))},t.prototype.createTournament=function(t,e){var n,r=p.Tournament.genTournamentClassID();void 0===e.loggingLevel&&(e.loggingLevel=this.log.level);var i=c.deepCopy(this.configs.defaultMatchConfigs);switch((e=a.deepMerge({defaultMatchConfigs:i},e)).type){case p.Tournament.Type.LADDER:n=new p.Tournament.Ladder(this.design,t,e,r,this);break;case p.Tournament.Type.ELIMINATION:n=new p.Tournament.Elimination(this.design,t,e,r,this)}return this.statistics.tournamentsCreated++,this.tournaments.set(n.id,n),n},t.prototype.getStation=function(){return t.Station},t.prototype.removeMatch=function(t){return r(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:return this.matches.has(t)?[4,this.matches.get(t).destroy()]:[3,2];case 1:return e.sent(),[2,this.matches.delete(t)];case 2:return[2,!1]}}))}))},t.prototype.setupSecurity=function(){},t.genDimensionID=function(){return u.genID(6)},t.prototype.use=function(t){return r(this,void 0,void 0,(function(){return i(this,(function(e){switch(e.label){case 0:switch(t.type){case m.Plugin.Type.DATABASE:return[3,1];case m.Plugin.Type.STORAGE:return[3,3]}return[3,5];case 1:return this.log.info("Attaching Database Plugin "+t.name),this.configs.backingDatabase="unknown",this.databasePlugin=t,[4,this.databasePlugin.initialize(this)];case 2:return e.sent(),[3,6];case 3:return this.log.info("Attaching Storage Plugin "+t.name),this.configs.backingStorage="unknown;",this.storagePlugin=t,[4,this.storagePlugin.initialize(this)];case 4:return e.sent(),[3,6];case 5:return[3,6];case 6:return[4,t.manipulate(this)];case 7:return e.sent(),[2]}}))}))},t.prototype.hasDatabase=function(){return void 0!==this.databasePlugin&&this.configs.backingDatabase!==s.NONE},t.prototype.hasStorage=function(){return this.storagePlugin&&this.configs.backingStorage!==o.NONE},t.prototype.cleanup=function(){return r(this,void 0,void 0,(function(){var t;return i(this,(function(e){switch(e.label){case 0:return this.cleaningUp?[2,this.cleaningUp]:(this.log.info("Cleaning up"),(t=[]).push(this.cleanupMatches()),t.push(this.cleanupTournaments()),this.getStation()&&t.push(this.getStation().stop()),this.cleaningUp=Promise.all(t),[4,this.cleaningUp]);case 1:return e.sent(),[2]}}))}))},t.prototype.cleanupMatches=function(){return r(this,void 0,void 0,(function(){var t;return i(this,(function(e){return t=[],this.matches.forEach((function(e){t.push(e.destroy())})),[2,Promise.all(t)]}))}))},t.prototype.cleanupTournaments=function(){return r(this,void 0,void 0,(function(){var t;return i(this,(function(e){return t=[],this.tournaments.forEach((function(e){t.push(e.destroy())})),[2,Promise.all(t)]}))}))},t.Station=null,t}();e.Dimension=v,e.create=function(t,e){return new v(t,e)}},2987:function(t,e){"use strict";var n,r=this&&this.__extends||(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});Object.defineProperty(e,"__esModule",{value:!0});var i=function(t){function e(n,r){var i=t.call(this,n)||this;return i.agentID=-1,i.agentID=r,i.name="AgentError",Object.setPrototypeOf(i,e.prototype),i}return r(e,t),e}(Error);e.AgentError=i;var s=function(t){function e(n,r){var i=t.call(this,n,r)||this;return i.name="AgentNotHandlingInputError",Object.setPrototypeOf(i,e.prototype),i}return r(e,t),e}(i);e.AgentNotHandlingInputError=s;var o=function(t){function e(n,r){var i=t.call(this,n,r)||this;return i.name="AgentInstallError",Object.setPrototypeOf(i,e.prototype),i}return r(e,t),e}(i);e.AgentInstallError=o;var a=function(t){function e(n,r){var i=t.call(this,n,r)||this;return i.name="AgentInstallTimeoutError",Object.setPrototypeOf(i,e.prototype),i}return r(e,t),e}(o);e.AgentInstallTimeoutError=a;var u=function(t){function e(n,r){var i=t.call(this,n,r)||this;return i.name="AgentCompileError",Object.setPrototypeOf(i,e.prototype),i}return r(e,t),e}(i);e.AgentCompileError=u;var c=function(t){function e(n,r){var i=t.call(this,n,r)||this;return i.name="AgentCompileTimeoutError",Object.setPrototypeOf(i,e.prototype),i}return r(e,t),e}(u);e.AgentCompileTimeoutError=c;var l=function(t){function e(n,r){var i=t.call(this,n,r)||this;return i.name="AgentFileError",Object.setPrototypeOf(i,e.prototype),i}return r(e,t),e}(i);e.AgentFileError=l;var h=function(t){function e(n,r){var i=t.call(this,n,r)||this;return i.name="AgentDirectoryError",Object.setPrototypeOf(i,e.prototype),i}return r(e,t),e}(i);e.AgentDirectoryError=h;var f=function(t){function e(n,r){var i=t.call(this,n,r)||this;return i.name="AgentMissingIDError",Object.setPrototypeOf(i,e.prototype),i}return r(e,t),e}(i);e.AgentMissingIDError=f},2464:function(t,e){"use strict";var n,r=this&&this.__extends||(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});Object.defineProperty(e,"__esModule",{value:!0});var i=function(t){function e(n){var r=t.call(this,n)||this;return r.name="DatabaseError",Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e}(Error);e.DatabaseError=i;var s=function(t){function e(n){var r=t.call(this,n)||this;return r.name="DatabaseGetUserError",Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e}(i);e.DatabaseGetUserError=s},5181:function(t,e){"use strict";var n,r=this&&this.__extends||(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});Object.defineProperty(e,"__esModule",{value:!0});var i=function(t){function e(n){var r=t.call(this,n)||this;return r.name="MatchError",Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e}(Error);e.MatchError=i;var s=function(t){function e(n){var r=t.call(this,n)||this;return r.name="MatchDestroyedError",Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e}(i);e.MatchDestroyedError=s;var o=function(t){function e(n){var r=t.call(this,n)||this;return r.name="MatchReplayFileError",Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e}(i);e.MatchReplayFileError=o;var a=function(t){function e(n){var r=t.call(this,n)||this;return r.name="MatchErrorLogFileError",Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e}(i);e.MatchErrorLogFileError=a},3776:function(t,e){"use strict";var n,r=this&&this.__extends||(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});Object.defineProperty(e,"__esModule",{value:!0});var i=function(t){function e(n){var r=t.call(this,n)||this;return r.name="TournamentError",Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e}(Error);e.TournamentError=i;var s=function(t){function e(n){var r=t.call(this,n)||this;return r.name="TournamentPlayerDoesNotExistError",Object.setPrototypeOf(r,e.prototype),r}return r(e,t),e}(i);e.TournamentPlayerDoesNotExistError=s},7792:function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});function s(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}Object.defineProperty(e,"__esModule",{value:!0});var o=function(t){function e(n){var r=t.call(this,n)||this;return r.name="DimensionError",Object.setPrototypeOf(r,e.prototype),r}return i(e,t),e}(Error);e.DimensionError=o;var a=function(t){function e(n){var r=t.call(this,n)||this;return r.name="MatchWarn",Object.setPrototypeOf(r,e.prototype),r}return i(e,t),e}(Error);e.MatchWarn=a;var u=function(t){function e(n){var r=t.call(this,n)||this;return r.name="FatalError",Object.setPrototypeOf(r,e.prototype),r}return i(e,t),e}(Error);e.FatalError=u;var c=function(t){function e(n){var r=t.call(this,n)||this;return r.name="MissingFilesError",Object.setPrototypeOf(r,e.prototype),r}return i(e,t),e}(u);e.MissingFilesError=c;var l=function(t){function e(n){var r=t.call(this,n)||this;return r.name="NotSupportedError",Object.setPrototypeOf(r,e.prototype),r}return i(e,t),e}(u);e.NotSupportedError=l;var h=function(t){function e(n){var r=t.call(this,n)||this;return r.name="SecurityError",Object.setPrototypeOf(r,e.prototype),r}return i(e,t),e}(Error);e.SecurityError=h,s(n(2987)),s(n(5181)),s(n(3776)),s(n(2464))},9418:function(t,e,n){"use strict";var r=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e};Object.defineProperty(e,"__esModule",{value:!0});var i=r(n(7792));e.DError=i},8579:function(t,e,n){"use strict";var r=this&&this.__spreadArrays||function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),i=0;for(e=0;e<n;e++)for(var s=arguments[e],o=0,a=s.length;o<a;o++,i++)r[i]=s[o];return r},i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});var s=i(n(8736)),o=function(){function t(e,n){void 0===e&&(e=t.LEVEL.INFO),void 0===n&&(n="Log"),this.level=e,this.identifierColor=s.default.bold.green,this.identifier=n}return t.prototype.getIdentifier=function(){return this.identifierColor(this.identifier)},t.prototype.bar=function(t){return void 0===t&&(t=""),"\n-=-=-=-=-=-=-=-=-=-=-=-| "+t+" "+this.getIdentifier()+" |-=-=-=-=-=-=-=-=-=-=-=-\n"},t.prototype.importantBar=function(){console.log(this.bar(s.default.red("[IMPORTANT]")))},t.prototype.important=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];console.log.apply(console,r([s.default.red("[IMPORTANT]")+" ("+this.identifier+") -"],t))},t.prototype.systemIObar=function(){this.level>=t.LEVEL.SYSTEM_IO&&console.log(this.bar(s.default.red("[SYSTEM I/O]")))},t.prototype.systemIO=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this.level>=t.LEVEL.SYSTEM_IO&&console.log.apply(console,r([s.default.red("[SYSTEM I/O]")+" ("+this.identifier+") -"],e))},t.prototype.systembar=function(){this.level>=t.LEVEL.SYSTEM&&console.log(this.bar(s.default.red("[SYSTEM]")))},t.prototype.system=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this.level>=t.LEVEL.SYSTEM&&console.log.apply(console,r([s.default.red("[SYSTEM]")+" ("+this.identifier+") -"],e))},t.prototype.detailbar=function(){this.level>=t.LEVEL.DETAIL&&console.log(this.bar(s.default.grey("[DETAIL]")))},t.prototype.detail=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this.level>=t.LEVEL.DETAIL&&console.log.apply(console,r([s.default.grey("[DETAIL]")+" ("+this.identifier+") -"],e))},t.prototype.infobar=function(){this.level>=t.LEVEL.INFO&&console.log(this.bar(s.default.blue("[INFO]")))},t.prototype.info=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this.level>=t.LEVEL.INFO&&console.log.apply(console,r([s.default.blue("[INFO]")+" ("+this.identifier+") -"],e))},t.prototype.warnbar=function(){this.level>=t.LEVEL.WARN&&console.log(this.bar(s.default.yellow("[WARN]")))},t.prototype.warn=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this.level>=t.LEVEL.WARN&&console.log.apply(console,r([s.default.yellow("[WARN]")+" ("+this.identifier+") -"],e))},t.prototype.errorbar=function(){this.level>=t.LEVEL.ERROR&&console.log(this.bar(s.default.red("[ERROR]")))},t.prototype.error=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this.level>=t.LEVEL.ERROR&&console.log.apply(console,r([s.default.red("[ERROR]")+" ("+this.identifier+") -"],e))},t}();e.Logger=o,function(t){var e;(e=t.LEVEL||(t.LEVEL={}))[e.NONE=0]="NONE",e[e.ERROR=1]="ERROR",e[e.WARN=2]="WARN",e[e.INFO=3]="INFO",e[e.DETAIL=4]="DETAIL",e[e.SYSTEM=5]="SYSTEM",e[e.SYSTEM_IO=6]="SYSTEM_IO",e[e.ALL=7]="ALL"}(o=e.Logger||(e.Logger={})),e.Logger=o},578:function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},i=this&&this.__generator||function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},s=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});var o=n(2943),a=n(1182),u=n(2605),c=n(8579),l=n(7792),h=a.MatchEngine.COMMAND_STREAM_TYPE,f=n(6046),d=n(8234),p=s(n(5622)),m=s(n(2664)),g=n(5660),y=n(1850),v=n(5747),_=function(){function t(e,n,r,i){void 0===r&&(r={}),this.design=e,this.agentFiles=n,this.dimension=i,this.agents=[],this.idToAgentsMap=new Map,this.timeStep=0,this.log=new c.Logger,this.results=null,this.matchStatus=t.Status.UNINITIALIZED,this.mapAgentIDtoTournamentID=new Map,this.configs={name:"",loggingLevel:c.Logger.LEVEL.INFO,engineOptions:{},secureMode:!1,agentOptions:d.deepCopy(u.Agent.OptionDefaults),languageSpecificAgentOptions:{},storeReplay:!0,storeReplayDirectory:"replays",storeErrorLogs:!0,storeErrorDirectory:"errorlogs",agentSpecificOptions:[],storeMatchErrorLogs:!1,detached:!1},this.shouldStop=!1,this.nonLocalFiles=[],this.configs=o.deepMerge(d.deepCopy(this.configs),d.deepCopy(r)),this.configs.agentOptions.secureMode=this.configs.secureMode,this.configs.agentOptions.loggingLevel=this.configs.loggingLevel,this.id=t.genMatchID(),this.creationDate=new Date,this.configs.name?this.name=this.configs.name:this.name="match_"+this.id,this.log.level=this.configs.loggingLevel,this.log.identifier=this.name,this.matchEngine=new a.MatchEngine(this.design,this.log.level),this.matchEngine.setEngineOptions(r.engineOptions)}return t.prototype.initialize=function(){return r(this,void 0,void 0,(function(){var e,n,r,s,o,a,c=this;return i(this,(function(i){switch(i.label){case 0:return i.trys.push([0,7,,10]),this.log.infobar(),this.log.info("Design: "+this.design.name+" | Initializing match - ID: "+this.id+", Name: "+this.name),e=this.design.getDesignOptions().override,this.log.detail("Match Configs",this.configs),this.timeStep=0,this.configs.storeErrorLogs&&(v.existsSync(this.configs.storeErrorDirectory)||v.mkdirSync(this.configs.storeErrorDirectory),n=this.getMatchErrorLogDirectory(),v.existsSync(n)||v.mkdirSync(n)),this.matchEngine.killOffSignal=!1,r=[],s=[],this.dimension.hasStorage()&&this.agentFiles.forEach((function(t,e){if(t.botkey&&t.file){var n=!1;c.configs.agentSpecificOptions[e]&&c.configs.agentSpecificOptions[e].useCachedBotFile&&(n=!0),r.push(c.retrieveBot(t.botkey,t.file,n)),s.push(e)}})),[4,Promise.all(r)];case 1:return o=i.sent(),s.forEach((function(t,e){"string"!=typeof c.agentFiles[t]&&(c.agentFiles[t].file=o[e],c.nonLocalFiles.push(p.default.dirname(o[e])))})),this.agents=u.Agent.generateAgents(this.agentFiles,this.configs.agentOptions,this.configs.languageSpecificAgentOptions),this.agents.forEach((function(t){c.idToAgentsMap.set(t.id,t),null!==t.tournamentID&&c.mapAgentIDtoTournamentID.set(t.id,t.tournamentID)})),this.configs.detached?[3,5]:e.active?(this.log.detail("Match Arguments",e.arguments),[4,this.matchEngine.initializeCustom()]):[3,3];case 2:return i.sent(),[3,5];case 3:return[4,this.matchEngine.initialize(this.agents,this)];case 4:i.sent(),i.label=5;case 5:return[4,this.design.initialize(this)];case 6:return i.sent(),this.matchStatus=t.Status.READY,[2,!0];case 7:return a=i.sent(),[4,this.handleLogFiles()];case 8:return i.sent(),[4,this.killAndCleanUp()];case 9:throw i.sent(),a instanceof l.AgentError&&(a instanceof l.AgentCompileError||a instanceof l.AgentInstallError)&&(this.agents[a.agentID].status=u.Agent.Status.CRASHED),a;case 10:return[2]}}))}))},t.prototype.retrieveBot=function(t,e,n){return r(this,void 0,void 0,(function(){var r,s,o;return i(this,(function(i){switch(i.label){case 0:return r=y.BOT_DIR+"/anon-"+f.genID(18),v.mkdirSync(r),s=p.default.join(r,"bot.zip"),[4,this.dimension.storagePlugin.download(t,s,n)];case 1:return o=i.sent(),[4,m.default(o,{dir:r})];case 2:return i.sent(),[2,p.default.join(r,p.default.basename(e))]}}))}))},t.prototype.run=function(){var e=this;return new Promise((function(n,s){return r(e,void 0,void 0,(function(){var e,r,o,a,u,c,h;return i(this,(function(i){switch(i.label){case 0:return i.trys.push([0,19,,20]),this.runReject=s,this.matchStatus=t.Status.RUNNING,(r=this.design.getDesignOptions().override).active?(this.log.system("Running custom"),[4,this.matchEngine.runCustom(this)]):[3,3];case 1:return i.sent(),o=this,[4,this.getResults()];case 2:return o.results=i.sent(),r.resultHandler&&(this.results=r.resultHandler(this.results)),[3,8];case 3:return[4,this.next()];case 4:e=i.sent(),i.label=5;case 5:if(e!=t.Status.FINISHED)return[3,3];i.label=6;case 6:return this.agents.forEach((function(t){t._clearTimer()})),a=this,[4,this.getResults()];case 7:a.results=i.sent(),i.label=8;case 8:return[4,this.killAndCleanUp()];case 9:return i.sent(),this.results.replayFile?v.existsSync(this.results.replayFile)?v.statSync(this.results.replayFile).isDirectory()?[3,14]:this.configs.storeReplay?(this.replayFile=this.results.replayFile,this.dimension.hasStorage()?(u=p.default.basename(this.results.replayFile),[4,this.dimension.storagePlugin.upload(this.results.replayFile,""+p.default.join(this.configs.storeReplayDirectory,u))]):[3,11]):[3,12]:[3,16]:[3,17];case 10:c=i.sent(),this.replayFileKey=c,g.removeFile(this.replayFile),i.label=11;case 11:return[3,13];case 12:g.removeFile(this.results.replayFile),i.label=13;case 13:return[3,15];case 14:s(new l.MatchReplayFileError("Replay file provided "+this.results.replayFile+" is not a file")),i.label=15;case 15:return[3,17];case 16:s(new l.MatchReplayFileError("Replay file provided "+this.results.replayFile+" does not exist")),i.label=17;case 17:return[4,this.handleLogFiles()];case 18:return i.sent(),this.finishDate=new Date,n(this.results),[3,20];case 19:return h=i.sent(),s(h),[3,20];case 20:return[2]}}))}))}))},t.prototype.handleLogFiles=function(){return r(this,void 0,void 0,(function(){var t,e,n,r,s,o,a,u=this;return i(this,(function(i){switch(i.label){case 0:if(t=[],e=[],this.configs.storeErrorLogs)for(n=function(n){var i=p.default.join(r.getMatchErrorLogDirectory(),n.getAgentErrorLogFilename());if(v.existsSync(i)){if(0===n._logsize)e.push(i);else if(r.dimension.hasStorage()){var s=r.dimension.storagePlugin.upload(i,i).then((function(t){return{key:t,agentID:n.id}}));t.push(s),e.push(i)}}else r.log.error("Agent "+r.id+" log file at "+i+" does not exist")},r=this,s=0,o=this.agents;s<o.length;s++)a=o[s],n(a);return[4,Promise.all(t)];case 1:return i.sent().forEach((function(t){u.idToAgentsMap.get(t.agentID).logkey=t.key})),e.length===this.agents.length?g.removeDirectory(this.getMatchErrorLogDirectory()):e.forEach((function(t){g.removeFile(t)})),[2]}}))}))},t.prototype.step=function(e){var n;return r(this,void 0,void 0,(function(){return i(this,(function(r){switch(r.label){case 0:return this.matchEngine.getEngineOptions().commandStreamType!==h.SEQUENTIAL?[3,2]:[4,this.design.update(this,e)];case 1:return[2,null!==(n=r.sent())&&void 0!==n?n:t.Status.RUNNING];case 2:throw new l.NotSupportedError("Only sequential streaming is allowed")}}))}))},t.prototype.next=function(){return r(this,void 0,void 0,(function(){var e,n,r;return i(this,(function(i){switch(i.label){case 0:return(e=this.matchEngine.getEngineOptions()).commandStreamType!==h.SEQUENTIAL?[3,5]:1!=this.shouldStop?[3,2]:(this.matchStatus=t.Status.STOPPED,this.matchEngine.stop(this),this.log.info("Stopped match"),this.resolveStopPromise(),[4,this.resumePromise]);case 1:i.sent(),this.matchEngine.resume(this),this.log.info("Resumed match"),this.shouldStop=!1,i.label=2;case 2:return this.agents.forEach((function(t){t.resume(),t._setupMove(),e.timeout.active&&t._setTimeout((function(){t.timeout()}),e.timeout.max+a.MatchEngine.timeoutBuffer)})),[4,this.matchEngine.getCommands(this)];case 3:return n=i.sent(),this.log.system("Retrieved "+n.length+" commands"),[4,this.design.update(this,n)];case 4:return r=i.sent(),this.matchStatus=r||t.Status.RUNNING,this.timeStep+=1,[2,r];case 5:if(e.commandStreamType===h.PARALLEL)throw new l.NotSupportedError("PARALLEL command streaming has not been implemented yet");i.label=6;case 6:return[2]}}))}))},t.prototype.stop=function(){var e=this;return new Promise((function(n,r){if(e.matchStatus!=t.Status.RUNNING)return e.log.warn("You can't stop a match that is not running"),void r(new l.MatchWarn("You can\t stop a match that is not running"));e.design.getDesignOptions().override.active?e.matchEngine.stopCustom(e).then((function(){e.matchStatus=t.Status.STOPPED,n()})).catch(r):(e.resolveStopPromise=n,e.log.info("Stopping match..."),e.resumePromise=new Promise((function(t){e.resumeResolve=t})),e.shouldStop=!0)}))},t.prototype.resume=function(){var e=this;return new Promise((function(n,r){if(e.matchStatus!=t.Status.STOPPED)return e.log.warn("You can't resume a match that is not stopped"),void r(new l.MatchWarn("You can't resume a match that is not stopped"));e.log.info("Resuming match..."),e.design.getDesignOptions().override.active?e.matchEngine.resumeCustom(e).then((function(){e.matchStatus=t.Status.RUNNING,n()})).catch(r):(e.matchStatus=t.Status.RUNNING,e.resumeResolve(),n())}))},t.prototype.killAndCleanUp=function(){return r(this,void 0,void 0,(function(){var t;return i(this,(function(e){switch(e.label){case 0:return[4,this.matchEngine.killAndClean(this)];case 1:return e.sent(),t=[],this.nonLocalFiles.forEach((function(e){t.push(g.removeDirectory(e))})),[4,Promise.all(t)];case 2:return e.sent(),[2]}}))}))},t.prototype.kill=function(t,e){return r(this,void 0,void 0,(function(){return i(this,(function(n){return t instanceof u.Agent?this.matchEngine.kill(t,e):this.matchEngine.kill(this.idToAgentsMap.get(t),e),[2]}))}))},t.prototype.getResults=function(){return r(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,this.design.getResults(this)];case 1:return[2,t.sent()]}}))}))},t.prototype.sendAll=function(t){var e=this;return new Promise((function(n){var r=[];e.agents.forEach((function(n){r.push(e.send(t,n))})),Promise.all(r).then((function(t){n(t.every((function(t){return!0===t})))}))}))},t.prototype.send=function(t,e){return r(this,void 0,void 0,(function(){var n,r;return i(this,(function(i){switch(i.label){case 0:if(!(e instanceof u.Agent))return[3,6];i.label=1;case 1:return i.trys.push([1,3,,5]),[4,this.matchEngine.send(this,t,e.id)];case 2:return i.sent(),[3,5];case 3:return n=i.sent(),this.log.error(n),[4,this.kill(e,"could not send message anymore")];case 4:return i.sent(),[2,!1];case 5:return[3,10];case 6:return i.trys.push([6,8,,10]),[4,this.matchEngine.send(this,t,e)];case 7:return i.sent(),[3,10];case 8:return r=i.sent(),this.log.error(r),[4,this.kill(e,"could not send message anymore")];case 9:return i.sent(),[2,!1];case 10:return[2,!0]}}))}))},t.prototype.throw=function(t,e){return r(this,void 0,void 0,(function(){var n,r;return i(this,(function(i){switch(i.label){case 0:return n=this.idToAgentsMap.get(t),e instanceof l.FatalError?[4,this.destroy()]:[3,2];case 1:return i.sent(),r="FatalError: "+n.name+" | "+e.message,this.log.error(r),this.configs.storeMatchErrorLogs&&n.writeToErrorLog(r),[3,3];case 2:e instanceof l.MatchWarn?(r="ID: "+t+", "+this.idToAgentsMap.get(t).name+" | "+e.message,this.log.warn(r),this.configs.storeMatchErrorLogs&&n.writeToErrorLog(r)):e instanceof l.MatchError?(r="ID: "+t+", "+this.idToAgentsMap.get(t).name+" | "+e.message,this.log.error(r),this.configs.storeMatchErrorLogs&&n.writeToErrorLog(r)):this.log.error("User tried throwing an error of type other than FatalError, MatchWarn, or MatchError"),i.label=3;case 3:return[2]}}))}))},t.prototype.destroy=function(){return r(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return this.runReject&&this.runReject(new l.MatchDestroyedError("Match was destroyed")),[4,this.killAndCleanUp()];case 1:return t.sent(),[4,this.matchEngine.killAndCleanCustom(this)];case 2:return t.sent(),[2]}}))}))},t.genMatchID=function(){return f.genID(12)},t.prototype.getMatchErrorLogDirectory=function(){return p.default.join(this.configs.storeErrorDirectory,"match_"+this.id)},t}();e.Match=_,function(t){var e;(e=t.Status||(t.Status={})).UNINITIALIZED="uninitialized",e.READY="ready",e.RUNNING="running",e.STOPPED="stopped",e.FINISHED="finished",e.ERROR="error"}(_=e.Match||(e.Match={})),e.Match=_},1182:function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},i=this&&this.__generator||function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},s=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});var o=s(n(2087)),a=n(3129),u=s(n(5747)),c=s(n(5622)),l=n(8234),h=n(2943),f=n(7792),d=n(8579),p=n(2605),m=n(578),g=s(n(8607)),y=n(1861),v=n(6046),_=function(){function t(t,n){this.engineOptions=l.deepCopy(e.DefaultMatchEngineOptions),this.log=new d.Logger,this.killOffSignal=!1,this.memoryWatchInterval=null,this.design=t,this.engineOptions=h.deepMerge(this.engineOptions,l.deepCopy(this.design.getDesignOptions().engineOptions)),this.overrideOptions=l.deepCopy(this.design.getDesignOptions().override),this.log.identifier="Engine",this.setLogLevel(n),this.docker=new g.default({socketPath:"/var/run/docker.sock"})}return t.prototype.setLogLevel=function(t){this.log.level=t},t.prototype.getEngineOptions=function(){return this.engineOptions},t.prototype.setEngineOptions=function(t){void 0===t&&(t={}),this.engineOptions=h.deepMerge(this.engineOptions,t)},t.prototype.initialize=function(t,e){return r(this,void 0,void 0,(function(){var t,n=this;return i(this,(function(r){switch(r.label){case 0:return this.log.systembar(),t=[],e.agents.forEach((function(r){t.push(n.initializeAgent(r,e))}),this),[4,Promise.all(t)];case 1:return r.sent(),this.log.system("FINISHED INITIALIZATION OF PROCESSES\n"),[2]}}))}))},t.prototype.initializeAgent=function(t,e){return r(this,void 0,void 0,(function(){var n,s,o,a,l,h=this;return i(this,(function(f){switch(f.label){case 0:return this.log.system("Setting up and spawning "+t.name+" | Command: "+t.cmd+" "+t.src),e.configs.secureMode?(n=e.id+"_agent_"+t.id,[4,t.setupContainer(n,this.docker,this.engineOptions)]):[3,2];case 1:f.sent(),f.label=2;case 2:return this.engineOptions.memory.active&&t.options.secureMode,s=c.default.join(e.getMatchErrorLogDirectory(),t.getAgentErrorLogFilename()),o=null,e.configs.storeErrorLogs&&(o=u.default.createWriteStream(s),t.errorLogWriteStream=o,o.write("=== Agent Install Log ===\n")),[4,t._install(o,o,this.engineOptions)];case 3:return f.sent(),this.log.system("Succesfully ran install step for agent "+t.id),e.configs.storeErrorLogs&&o.write("=== Agent Compile Log ===\n"),[4,t._compile(o,o,this.engineOptions)];case 4:return f.sent(),this.log.system("Succesfully ran compile step for agent "+t.id),a=null,[4,t._spawn()];case 5:return a=f.sent(),this.log.system("Spawned agent "+t.id),y.isChildProcess(a)?(t._storeProcess(a),t.streams.in=a.stdin,t.streams.out=a.stdout,t.streams.err=a.stderr,a.on("close",(function(e){t.emit(p.Agent.AGENT_EVENTS.CLOSE,e)})),t.streams.in.on("error",v.noop)):(t.streams.in=a.in,t.streams.out=a.out,t.streams.err=a.err,l=a.exec,a.stream.on("end",(function(){return r(h,void 0,void 0,(function(){var e;return i(this,(function(n){switch(n.label){case 0:return[4,l.inspect()];case 1:return e=n.sent(),t.emit(p.Agent.AGENT_EVENTS.CLOSE,e.ExitCode),[2]}}))}))}))),t.on(p.Agent.AGENT_EVENTS.EXCEED_MEMORY_LIMIT,(function(){h.engineOptions.memory.memoryCallback(t,e,h.engineOptions)})),t.on(p.Agent.AGENT_EVENTS.TIMEOUT,(function(){h.engineOptions.timeout.timeoutCallback(t,e,h.engineOptions)})),e.idToAgentsMap.set(t.id,t),t.status=p.Agent.Status.RUNNING,t.streams.out.on("readable",(function(){for(var e;e=t.streams.out.read();){var n=(""+e).split("\n"),r=""===n[n.length-1];n.length>1&&(n[0]=t._buffer.join("").concat(n[0]),t._buffer=[]);for(var i=0;i<n.length-1;i++)""!==n[i]&&t.isAllowedToSendCommands()&&h.handleCommand(t,n[i]);h.engineOptions.commandLines.waitForNewline&&n.length>=1&&!r&&t._buffer.push(n[n.length-1])}})),this.engineOptions.noStdErr||t.streams.err.on("data",(function(e){h.log.error(t.id+": "+e.slice(0,e.length-1))})),e.configs.storeErrorLogs&&(o.write("=== Agent Error Log ===\n"),t.streams.err.on("data",(function(e){t._logsize<t.options.logLimit?(t._logsize+=e.length,o.write(""+e)):!1===t._trimmed&&(t._trimmed=!0,h.log.warn("agent "+t.id+"'s logs were trimmed"),o.write("\nend of logs as logs were trimmed\n"))}))),t.on(p.Agent.AGENT_EVENTS.CLOSE,(function(n){t.isTerminated()||(t.options.secureMode&&137===n?(h.kill(t,"agent closed but agent not terminated yet, likely exceeded memory"),h.engineOptions.memory.memoryCallback(t,e,h.engineOptions)):h.kill(t,"agent closed but agent not terminated yet")),h.log.system(t.name+" | id: "+t.id+" - exited with code "+n)})),this.engineOptions.memory.active&&(t.options.secureMode||t._setupMemoryWatcher(this.engineOptions)),this.killOffSignal&&this.kill(t,"engine has killOffSignal on, killing agent during initialization"),[2]}}))}))},t.prototype.handleCommand=function(e,n){return r(this,void 0,void 0,(function(){return i(this,(function(r){switch(r.label){case 0:if(this.engineOptions.commandStreamType!==t.COMMAND_STREAM_TYPE.SEQUENTIAL)return[3,12];switch(this.engineOptions.commandFinishPolicy){case t.COMMAND_FINISH_POLICIES.FINISH_SYMBOL:return[3,1];case t.COMMAND_FINISH_POLICIES.LINE_COUNT:return[3,5];case t.COMMAND_FINISH_POLICIES.CUSTOM:return[3,11]}return[3,12];case 1:return""+n!==this.engineOptions.commandFinishSymbol?[3,3]:[4,e._finishMove()];case 2:return r.sent(),[3,4];case 3:e.currentMoveCommands.push(n),r.label=4;case 4:return[3,12];case 5:return""+n!==this.engineOptions.commandFinishSymbol?[3,7]:[4,e._finishMove()];case 6:return r.sent(),[3,10];case 7:return e.currentMoveCommands.length<this.engineOptions.commandLines.max-1?(e.currentMoveCommands.push(n),[3,10]):[3,8];case 8:return e.currentMoveCommands.length!=this.engineOptions.commandLines.max-1?[3,10]:[4,e._finishMove()];case 9:r.sent(),e.currentMoveCommands.push(n),r.label=10;case 10:return[3,12];case 11:throw new f.NotSupportedError("Custom command finish policies are not allowed yet");case 12:return[2]}}))}))},t.prototype.stop=function(t){return r(this,void 0,void 0,(function(){var e;return i(this,(function(n){switch(n.label){case 0:return e=[],t.agents.forEach((function(t){e.push(t.stop())})),[4,Promise.all(e)];case 1:return n.sent(),this.log.system("Stopped all agents"),[2]}}))}))},t.prototype.resume=function(t){return r(this,void 0,void 0,(function(){var e;return i(this,(function(n){switch(n.label){case 0:return e=[],t.agents.forEach((function(t){e.push(t.resume())})),[4,Promise.all(e)];case 1:return n.sent(),this.log.system("Resumed all agents"),[2]}}))}))},t.prototype.killAndClean=function(t){return r(this,void 0,void 0,(function(){var e,n=this;return i(this,(function(r){switch(r.label){case 0:return this.killOffSignal=!0,clearInterval(this.memoryWatchInterval),e=[],t.agents&&t.agents.forEach((function(t){e.push(n.kill(t,"cleanup"))})),[4,Promise.all(e)];case 1:return r.sent(),[2]}}))}))},t.prototype.kill=function(t,e){return void 0===e&&(e="unspecified"),r(this,void 0,void 0,(function(){var n;return i(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,t._terminate()];case 1:return r.sent(),this.log.system("Killed off agent "+t.id+" - "+t.name,"Reason: "+e),[3,3];case 2:return n=r.sent(),this.log.error("This should not happen when terminating agents.",n),[3,3];case 3:return t._currentMoveResolve(),[2]}}))}))},t.prototype.getCommands=function(t){var e=this;return new Promise((function(n){var r=[],i=t.agents.filter((function(t){return!t.isTerminated()})).map((function(t){return t._currentMovePromise}));Promise.all(i).then((function(){e.log.system("All move promises resolved"),t.agents.forEach((function(t){t.currentMoveCommands.forEach((function(n){n.split(e.engineOptions.commandDelimiter).forEach((function(e){""!==e&&r.push({command:e,agentID:t.id})}))}))})),e.log.systemIO("Agent commands at end of time step "+t.timeStep+" to be sent to match on time step "+(t.timeStep+1)+" "),e.log.systemIO(r.length?JSON.stringify(r):"No commands"),n(r)}))}))},t.prototype.send=function(t,e,n){var r=this;return new Promise((function(i,s){var o=t.idToAgentsMap.get(n);if(o.options.detached||!o.inputDestroyed()&&!o.isTerminated()){var a=o.options.detached?""+e:e+"\n";o.write(a,(function(t){t&&s(t),i(!0)}))||s(new f.AgentNotHandlingInputError("Input stream buffer highWaterMark reached, agent is not processing input",n))}else r.log.error("Agent "+n+" - "+o.name+" - has been killed off already, can't send messages now"),i(!1)}))},t.prototype.initializeCustom=function(){return r(this,void 0,void 0,(function(){return i(this,(function(t){return[2,!0]}))}))},t.prototype.runCustom=function(t){var e=this;return new Promise((function(n,r){0==e.overrideOptions.active&&r(new f.FatalError("Override was not set active! Make sure to set the overide.active field to true"));var i,s=e.overrideOptions.command,l=e.parseCustomArguments(t,e.overrideOptions.arguments);t.matchProcess=a.spawn(s,l).on("error",(function(t){if(t)throw t})),e.log.system(t.name+" | id: "+t.id+" - spawned: "+s+" "+l.join(" "));var h=c.default.join(t.getMatchErrorLogDirectory(),"match_error.log"),d=null;t.configs.storeErrorLogs&&(d=u.default.createWriteStream(h)),t.configs.storeErrorLogs&&(d.write("=== Custom Match Error Log ===\n"),t.matchProcess.stderr.pipe(d));var p=!1;null!==e.overrideOptions.timeout&&(i=setTimeout((function(){e.log.system(t.name+" | id: "+t.id+" - Timed out"),t.matchProcess.kill("SIGKILL"),p=!0}),e.overrideOptions.timeout));var m=!1;t.matchProcess.stdout.on("readable",(function(){for(var n;n=t.matchProcess.stdout.read();)for(var r=(""+n).split("\n"),i=0;i<r.length;i++){var s=r[i];""!==s&&(s===e.overrideOptions.conclude_command?m=!0:m?t.results.push(s):t.state.matchOutput.push(s))}})),t.matchProcess.stdout.on("close",(function(s){e.log.system(t.name+" | id: "+t.id+" - exited with code "+s),p?r(new f.MatchError("Match timed out")):(clearTimeout(i),n(t.results)),t.agents.forEach((function(t){if(t.options.secureMode){var n=o.default.tmpdir();t.cwd.slice(0,n.length)===n?a.exec("sudo rm -rf "+t.cwd):e.log.error("couldn't remove agent files while in secure mode")}}))}))}))},t.prototype.stopCustom=function(t){return r(this,void 0,void 0,(function(){return i(this,(function(e){return t.matchProcess.kill("SIGSTOP"),[2]}))}))},t.prototype.resumeCustom=function(t){return r(this,void 0,void 0,(function(){return i(this,(function(e){return t.matchProcess.kill("SIGCONT"),[2]}))}))},t.prototype.killAndCleanCustom=function(t){return r(this,void 0,void 0,(function(){return i(this,(function(e){return t.matchProcess&&t.matchProcess.kill("SIGKILL"),[2]}))}))},t.prototype.parseCustomArguments=function(e,n){if(e.matchStatus===m.Match.Status.UNINITIALIZED)throw new f.FatalError("Match "+e.id+" - "+e.name+" is not initialized yet");for(var r=[],i=0;i<n.length;i++)switch(n[i]){case t.DynamicDataStrings.D_FILES:e.agents.forEach((function(t){r.push(t.file)}));break;case t.DynamicDataStrings.D_TOURNAMENT_IDS:e.agents.forEach((function(t){r.push(t.tournamentID.id?t.tournamentID:"0")}));break;case t.DynamicDataStrings.D_AGENT_IDS:e.agents.forEach((function(t){r.push(t.id)}));break;case t.DynamicDataStrings.D_MATCH_ID:r.push(e.id);break;case t.DynamicDataStrings.D_MATCH_NAME:r.push(e.name);break;case t.DynamicDataStrings.D_NAMES:e.agents.forEach((function(t){var e=t.name;e=(e=e.replace(/\//g,"-")).replace(/ /g,"_"),r.push(e)}));break;default:r.push(n[i])}return r},t.prototype.getLogger=function(){return this.log},t.timeoutBuffer=25,t}();e.MatchEngine=_,function(t){var e,n,r;(r=t.COMMAND_FINISH_POLICIES||(t.COMMAND_FINISH_POLICIES={})).FINISH_SYMBOL="finish_symbol",r.LINE_COUNT="line_count",r.CUSTOM="custom",(n=t.COMMAND_STREAM_TYPE||(t.COMMAND_STREAM_TYPE={})).PARALLEL="parallel",n.SEQUENTIAL="sequential",(e=t.DynamicDataStrings||(t.DynamicDataStrings={})).D_FILES="D_FILES",e.D_AGENT_IDS="D_AGENT_IDS",e.D_TOURNAMENT_IDS="D_TOURNAMENT_IDS",e.D_MATCH_ID="D_MATCH_ID",e.D_MATCH_NAME="D_MATCH_NAME",e.D_NAMES="D_NAMES"}(_=e.MatchEngine||(e.MatchEngine={})),e.MatchEngine=_,e.DefaultMatchEngineOptions={commandStreamType:_.COMMAND_STREAM_TYPE.SEQUENTIAL,commandDelimiter:",",commandFinishSymbol:"D_FINISH",commandFinishPolicy:_.COMMAND_FINISH_POLICIES.FINISH_SYMBOL,commandLines:{max:1,waitForNewline:!0},noStdErr:!0,timeout:{max:1e3,active:!0,timeoutCallback:function(t,e,n){e.kill(t.id,"timed out"),e.log.error("agent "+t.id+" - '"+t.name+"' timed out after "+n.timeout.max+" ms")}},memory:{limit:1e9,active:!0,usePs:!0,memoryCallback:function(t,e,n){e.kill(t.id,"exceed memory limit"),e.log.error("agent "+t.id+" - '"+t.name+"' reached the memory limit of "+n.memory.limit/1e6+" MB")},checkRate:100}}},3032:function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var s=n(2943),o=function(t){function e(e){var n=t.call(this)||this;return n.configs={saveMatches:!0,saveTournamentMatches:!0},s.deepMerge(n.configs,e),n}return i(e,t),e}(n(3892).Plugin);e.Database=o},4353:function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.configs={},e}return i(e,t),e}(n(3892).Plugin);e.Storage=s},3892:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){};e.Plugin=r;var i=n(3032),s=n(4353);!function(t){var e;(e=t.Type||(t.Type={})).DATABASE="database",e.STORAGE="storage",e.OTHER="other",t.Database=i.Database,t.Storage=s.Storage}(r=e.Plugin||(e.Plugin={})),e.Plugin=r},6354:t=>{"use strict";t.exports=JSON.parse('{"defaultAction":"SCMP_ACT_ERRNO","archMap":[{"architecture":"SCMP_ARCH_X86_64","subArchitectures":["SCMP_ARCH_X86","SCMP_ARCH_X32"]},{"architecture":"SCMP_ARCH_AARCH64","subArchitectures":["SCMP_ARCH_ARM"]},{"architecture":"SCMP_ARCH_MIPS64","subArchitectures":["SCMP_ARCH_MIPS","SCMP_ARCH_MIPS64N32"]},{"architecture":"SCMP_ARCH_MIPS64N32","subArchitectures":["SCMP_ARCH_MIPS","SCMP_ARCH_MIPS64"]},{"architecture":"SCMP_ARCH_MIPSEL64","subArchitectures":["SCMP_ARCH_MIPSEL","SCMP_ARCH_MIPSEL64N32"]},{"architecture":"SCMP_ARCH_MIPSEL64N32","subArchitectures":["SCMP_ARCH_MIPSEL","SCMP_ARCH_MIPSEL64"]},{"architecture":"SCMP_ARCH_S390X","subArchitectures":["SCMP_ARCH_S390"]}],"syscalls":[{"names":["accept","accept4","access","adjtimex","alarm","bind","brk","capget","capset","chdir","chmod","chown","chown32","clock_adjtime","clock_adjtime64","clock_getres","clock_getres_time64","clock_gettime","clock_gettime64","clock_nanosleep","clock_nanosleep_time64","close","connect","copy_file_range","creat","dup","dup2","dup3","epoll_create","epoll_create1","epoll_ctl","epoll_ctl_old","epoll_pwait","epoll_wait","epoll_wait_old","eventfd","eventfd2","execve","execveat","exit","exit_group","faccessat","fadvise64","fadvise64_64","fallocate","fanotify_mark","fchdir","fchmod","fchmodat","fchown","fchown32","fchownat","fcntl","fcntl64","fdatasync","fgetxattr","flistxattr","flock","fork","fremovexattr","fsetxattr","fstat","fstat64","fstatat64","fstatfs","fstatfs64","fsync","ftruncate","ftruncate64","futex","futex_time64","futimesat","getcpu","getcwd","getdents","getdents64","getegid","getegid32","geteuid","geteuid32","getgid","getgid32","getgroups","getgroups32","getitimer","getpeername","getpgid","getpgrp","getpid","getppid","getpriority","getrandom","getresgid","getresgid32","getresuid","getresuid32","getrlimit","get_robust_list","getrusage","getsid","getsockname","getsockopt","get_thread_area","gettid","gettimeofday","getuid","getuid32","getxattr","inotify_add_watch","inotify_init","inotify_init1","inotify_rm_watch","io_cancel","ioctl","io_destroy","io_getevents","io_pgetevents","io_pgetevents_time64","ioprio_get","ioprio_set","io_setup","io_submit","io_uring_enter","io_uring_register","io_uring_setup","ipc","kill","lchown","lchown32","lgetxattr","link","linkat","listen","listxattr","llistxattr","_llseek","lremovexattr","lseek","lsetxattr","lstat","lstat64","madvise","membarrier","memfd_create","mincore","mkdir","mkdirat","mknod","mknodat","mlock","mlock2","mlockall","mmap","mmap2","mprotect","mq_getsetattr","mq_notify","mq_open","mq_timedreceive","mq_timedreceive_time64","mq_timedsend","mq_timedsend_time64","mq_unlink","mremap","msgctl","msgget","msgrcv","msgsnd","msync","munlock","munlockall","munmap","nanosleep","newfstatat","_newselect","open","openat","pause","pipe","pipe2","poll","ppoll","ppoll_time64","prctl","pread64","preadv","preadv2","prlimit64","pselect6","pselect6_time64","pwrite64","pwritev","pwritev2","read","readahead","readlink","readlinkat","readv","recv","recvfrom","recvmmsg","recvmmsg_time64","recvmsg","remap_file_pages","removexattr","rename","renameat","renameat2","restart_syscall","rmdir","rseq","rt_sigaction","rt_sigpending","rt_sigprocmask","rt_sigqueueinfo","rt_sigreturn","rt_sigsuspend","rt_sigtimedwait","rt_sigtimedwait_time64","rt_tgsigqueueinfo","sched_getaffinity","sched_getattr","sched_getparam","sched_get_priority_max","sched_get_priority_min","sched_getscheduler","sched_rr_get_interval","sched_rr_get_interval_time64","sched_setaffinity","sched_setattr","sched_setparam","sched_setscheduler","sched_yield","seccomp","select","semctl","semget","semop","semtimedop","semtimedop_time64","send","sendfile","sendfile64","sendmmsg","sendmsg","sendto","setfsgid","setfsgid32","setfsuid","setfsuid32","setgid","setgid32","setgroups","setgroups32","setitimer","setpgid","setpriority","setregid","setregid32","setresgid","setresgid32","setresuid","setresuid32","setreuid","setreuid32","setrlimit","set_robust_list","setsid","setsockopt","set_thread_area","set_tid_address","setuid","setuid32","setxattr","shmat","shmctl","shmdt","shmget","shutdown","sigaltstack","signalfd","signalfd4","sigprocmask","sigreturn","socket","socketcall","socketpair","splice","stat","stat64","statfs","statfs64","statx","symlink","symlinkat","sync","sync_file_range","syncfs","sysinfo","tee","tgkill","time","timer_create","timer_delete","timer_getoverrun","timer_gettime","timer_gettime64","timer_settime","timer_settime64","timerfd_create","timerfd_gettime","timerfd_gettime64","timerfd_settime","timerfd_settime64","times","tkill","truncate","truncate64","ugetrlimit","umask","uname","unlink","unlinkat","utime","utimensat","utimensat_time64","utimes","vfork","vmsplice","wait4","waitid","waitpid","write","writev"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{},"excludes":{}},{"names":["ptrace"],"action":"SCMP_ACT_ALLOW","args":null,"comment":"","includes":{"minKernel":"4.8"},"excludes":{}},{"names":["personality"],"action":"SCMP_ACT_ALLOW","args":[{"index":0,"value":0,"valueTwo":0,"op":"SCMP_CMP_EQ"}],"comment":"","includes":{},"excludes":{}},{"names":["personality"],"action":"SCMP_ACT_ALLOW","args":[{"index":0,"value":8,"valueTwo":0,"op":"SCMP_CMP_EQ"}],"comment":"","includes":{},"excludes":{}},{"names":["personality"],"action":"SCMP_ACT_ALLOW","args":[{"index":0,"value":131072,"valueTwo":0,"op":"SCMP_CMP_EQ"}],"comment":"","includes":{},"excludes":{}},{"names":["personality"],"action":"SCMP_ACT_ALLOW","args":[{"index":0,"value":131080,"valueTwo":0,"op":"SCMP_CMP_EQ"}],"comment":"","includes":{},"excludes":{}},{"names":["personality"],"action":"SCMP_ACT_ALLOW","args":[{"index":0,"value":4294967295,"valueTwo":0,"op":"SCMP_CMP_EQ"}],"comment":"","includes":{},"excludes":{}},{"names":["sync_file_range2"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"arches":["ppc64le"]},"excludes":{}},{"names":["arm_fadvise64_64","arm_sync_file_range","sync_file_range2","breakpoint","cacheflush","set_tls"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"arches":["arm","arm64"]},"excludes":{}},{"names":["arch_prctl"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"arches":["amd64","x32"]},"excludes":{}},{"names":["modify_ldt"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"arches":["amd64","x32","x86"]},"excludes":{}},{"names":["s390_pci_mmio_read","s390_pci_mmio_write","s390_runtime_instr"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"arches":["s390","s390x"]},"excludes":{}},{"names":["open_by_handle_at"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"caps":["CAP_DAC_READ_SEARCH"]},"excludes":{}},{"names":["bpf","clone","fanotify_init","lookup_dcookie","mount","name_to_handle_at","perf_event_open","quotactl","setdomainname","sethostname","setns","syslog","umount","umount2","unshare"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"caps":["CAP_SYS_ADMIN"]},"excludes":{}},{"names":["clone"],"action":"SCMP_ACT_ALLOW","args":[{"index":0,"value":2114060288,"valueTwo":0,"op":"SCMP_CMP_MASKED_EQ"}],"comment":"","includes":{},"excludes":{"caps":["CAP_SYS_ADMIN"],"arches":["s390","s390x"]}},{"names":["clone"],"action":"SCMP_ACT_ALLOW","args":[{"index":1,"value":2114060288,"valueTwo":0,"op":"SCMP_CMP_MASKED_EQ"}],"comment":"s390 parameter ordering for clone is different","includes":{"arches":["s390","s390x"]},"excludes":{"caps":["CAP_SYS_ADMIN"]}},{"names":["reboot"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"caps":["CAP_SYS_BOOT"]},"excludes":{}},{"names":["chroot"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"caps":["CAP_SYS_CHROOT"]},"excludes":{}},{"names":["delete_module","init_module","finit_module"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"caps":["CAP_SYS_MODULE"]},"excludes":{}},{"names":["acct"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"caps":["CAP_SYS_PACCT"]},"excludes":{}},{"names":["kcmp","process_vm_readv","process_vm_writev","ptrace"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"caps":["CAP_SYS_PTRACE"]},"excludes":{}},{"names":["iopl","ioperm"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"caps":["CAP_SYS_RAWIO"]},"excludes":{}},{"names":["settimeofday","stime","clock_settime"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"caps":["CAP_SYS_TIME"]},"excludes":{}},{"names":["vhangup"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"caps":["CAP_SYS_TTY_CONFIG"]},"excludes":{}},{"names":["get_mempolicy","mbind","set_mempolicy"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"caps":["CAP_SYS_NICE"]},"excludes":{}},{"names":["syslog"],"action":"SCMP_ACT_ALLOW","args":[],"comment":"","includes":{"caps":["CAP_SYSLOG"]},"excludes":{}}]}')},4925:function(t,e){"use strict";var n,r=this&&this.__extends||(n=function(t,e){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});Object.defineProperty(e,"__esModule",{value:!0});var i=function(t){function e(e,n){var r=t.call(this,n.toString())||this;return r.status=e,r.name=r.constructor.name,r.status=e,r.message=n.toString(),r}return r(e,t),e}(Error);e.HttpError=i;var s=function(t){function e(e){return t.call(this,200,e||"User Error")||this}return r(e,t),e}(i);e.UserError=s;var o=function(t){function e(e){return t.call(this,400,e||"Bad Request")||this}return r(e,t),e}(i);e.BadRequest=o;var a=function(t){function e(e){return t.call(this,401,e||"Unauthorized")||this}return r(e,t),e}(i);e.Unauthorized=a;var u=function(t){function e(e){return t.call(this,403,e||"Permission denied")||this}return r(e,t),e}(i);e.Forbidden=u;var c=function(t){function e(e){return t.call(this,404,e||"Resource not found")||this}return r(e,t),e}(i);e.NotFound=c;var l=function(t){function e(e){return t.call(this,422,e||"Unprocessable request")||this}return r(e,t),e}(i);e.Unprocessable=l;var h=function(t){function e(e){return t.call(this,500,e||"Internal server error")||this}return r(e,t),e}(i);e.InternalServerError=h;var f=function(t){function e(e){return t.call(this,501,e||"Not Implemented")||this}return r(e,t),e}(i);e.NotImplemented=f,e.errorHandler=function(t){return function(e,n,r,i){e||(e=new h("An unknown error occurred in the errorHandler")),e.status||(e=new h(e.message)),e.status>=500?t.error(""+e.status,e):t.warn(e.status+": "+e.message),r.status(e.status).json({error:{status:e.status,message:""+e.message}})}}},9822:function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},i=this&&this.__generator||function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},s=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});var a=s(n(4925)),u=o(n(2751)),c=o(n(2664)),l=n(5747),h=o(n(5622)),f=n(1850),d=n(6046),p=n(5660);e.handleBotUpload=function(t,e){return new Promise((function(n,s){var o=u.default({multiples:!0});try{o.parse(t,(function(o,u,c){return r(void 0,void 0,void 0,(function(){var r,l,h,f,d,p,g,y,v,_;return i(this,(function(i){if(o)throw o;if(void 0===c.files)throw new a.BadRequest("No file(s) provided");if(void 0===u.paths)throw new a.BadRequest("No file path(s) provided");if(c.files.length||(c.files=[c.files]),u.paths=JSON.parse(u.paths),u.names=JSON.parse(u.names),u.playerIDs=JSON.parse(u.playerIDs),!u.paths.length)throw new a.BadRequest("No file path(s) provided");if(u.paths.length!=c.files.length)throw new a.BadRequest("Paths and File arrays mismatch");for(r=c.files,l=u.paths,h=u.names,f=u.playerIDs,h||(h=[]),d=[],p=0;p<r.length;p++){if(g=r[p],-1!==(y=l[p]).indexOf("/")||-1!==y.indexOf("\\"))return s(new a.BadRequest("Path for file/directory cannot have / or \\ in them. File/directory must be in root directory after unzipping file")),[2];if(v=h[p],_=f[p],e&&e.playerID!==_&&!t.data.dimension.databasePlugin.isAdmin(e))return s(new a.Unauthorized("Insufficient permissions to upload bot for this player ID")),[2];d.push(m(g,y,v,_))}return Promise.all(d).then(n).catch(s),[2]}))}))}))}catch(t){s(t)}}))};var m=function(t,e,n,s){return r(void 0,void 0,void 0,(function(){var r,o,u,m,g;return i(this,(function(i){switch(i.label){case 0:r=d.genID(18),o=f.BOT_DIR+"/bot-"+s+"-"+r,i.label=1;case 1:return i.trys.push([1,3,,4]),[4,c.default(t.path,{dir:o})];case 2:return i.sent(),[3,4];case 3:throw u=i.sent(),p.removeDirectory(o),new a.InternalServerError(u);case 4:if(m=h.default.join(o,e),g=n,l.existsSync(m))return[2,{name:g,file:m,playerID:s,botdir:o,originalFile:t.path}];throw p.removeDirectory(o),new a.BadRequest("Extracted zip file to bot-"+s+"-"+r+" but path to file "+e+" does not exist in the extracted directory")}}))}))}},1850:function(t,e,n){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}},i=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e};Object.defineProperty(e,"__esModule",{value:!0});var s=r(n(7996)),o=r(n(5622)),a=r(n(2099)),u=r(n(6928)),c=n(8579),l=i(n(4925)),h=r(n(3827)),f=r(n(4596)),d=n(2943),p=n(8234);e.BOT_DIR=o.default.join(__dirname,"../../../../local/bots");var m=function(){function t(e,n,r){var i=this;if(void 0===e&&(e=""),void 0===r&&(r={}),this.id=0,this.port=9e3,this.webport=3e3,this.maxAttempts=16,this.log=new c.Logger(c.Logger.LEVEL.INFO,"Station Log"),this.configs={disableUploads:!1,loggingLevel:c.Logger.LEVEL.INFO,requireAuth:!0},this.configs=d.deepMerge(this.configs,p.deepCopy(r)),this.log.level=this.configs.loggingLevel,this.id=t._id,this.name=e||"Station_"+this.id,t._id++,this.log.identifier=this.name+" Log",this.app=s.default(),this.app.use(h.default()),this.app.use(f.default.json()),this.app.use(f.default.urlencoded({extended:!0})),n instanceof Array){var o=new Map;n.forEach((function(t){o.set(t.id,t)})),this.app.set("dimensions",o)}else{var m=new Map;m.set(n.id,n),this.app.set("dimensions",m)}this.app.use("/**/*",(function(t,e,n){t.data={},n()})),this.app.get("/",(function(t,e){e.json({msg:"api live at /api"})})),this.app.get("/api",(function(t,e){e.json({msg:"api live at /api"})})),this.app.use("/api/status",a.default),this.app.use("/api/dimensions",u.default),this.app.use(l.errorHandler(this.log)),this.log.system("All middleware setup"),this.tryToListen(this.app,this.port).then((function(t){i.port=t,function(){i.log.info("Running '"+i.name+"' API at port "+i.port+". API served at http://localhost:"+i.port);var t=[];i.app.get("dimensions").forEach((function(e){return t.push(e.name)})),i.log.info("Observing dimensions: "+t)}()})).catch((function(){i.log.error("Station: "+i.name+", couldn't find an open port after 16 attempts")}))}return t.prototype.tryToListen=function(t,e){var n=this,r=0;return new Promise((function(i,s){n.server=t.listen(e).on("error",(function(){++r<n.maxAttempts?n.tryToListen(t,e+1).then((function(){i(e+1)})):s()})).on("listening",(function(){i(e)}))}))},t.prototype.setLogLevel=function(t){this.log.level=t},t.prototype.restart=function(){var t=this;return new Promise((function(e,n){t.log.warn("RESTARTING"),t.server.close((function(r){r&&n(r),t.tryToListen(t.app,t.port).then(e).catch(n)}))}))},t.prototype.stop=function(){var t=this;return new Promise((function(e,n){t.log.warn("Stopping"),t.server.close((function(t){t&&n(t),e()}))}))},t.prototype.observe=function(t){var e=this.app.get("dimensions");e.set(t.id,t),this.app.set("dimensions",e)},t._id=0,t}();e.Station=m},6577:function(t,e,n){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}},i=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e};Object.defineProperty(e,"__esModule",{value:!0});var s=r(n(7996)),o=i(n(4925)),a=s.default.Router();e.requireAuth=function(t,e,n){if(t.data.dimension.hasDatabase())if(t.data.dimension.getStation().configs.requireAuth){var r=t.get("Authorization");if(!r)return n(new o.Unauthorized("Missing auth token"));var i=r.split(" ");if(2!==i.length||"Bearer"!==i[0]||0===i[1].length)return n(new o.Unauthorized("Invalid auth token format"));t.data.dimension.databasePlugin.verifyToken(i[1]).then((function(e){t.data.user=e,n()})).catch(n)}else t.data.dimension.databasePlugin.getUser("admin",!1).then((function(e){t.data.user=e,n()}));else n()},e.storeAuth=function(t,e,n){if(t.data.dimension.hasDatabase())if(t.data.dimension.getStation().configs.requireAuth){var r=t.get("Authorization");if(!r)return n();var i=r.split(" ");if(2!==i.length||"Bearer"!==i[0]||0===i[1].length)return n();t.data.dimension.databasePlugin.verifyToken(i[1]).then((function(e){t.data.user=e,n()})).catch((function(){n()}))}else t.data.dimension.databasePlugin.getUser("admin",!1).then((function(e){t.data.user=e,n()}));else n()},e.requireAdmin=function(t,e,n){if(t.data.dimension.hasDatabase())if(t.data.dimension.getStation().configs.requireAuth){var r=t.get("Authorization");if(!r)return n(new o.Unauthorized("Missing auth token"));var i=r.split(" ");if(2!==i.length||"Bearer"!==i[0]||0===i[1].length)return n(new o.Unauthorized("Invalid auth token format"));var s=t.data.dimension;s.databasePlugin.verifyToken(i[1]).then((function(e){s.databasePlugin.isAdmin(e)?(t.data.user=e,n()):n(new o.Unauthorized("Requires admin access"))})).catch(n)}else t.data.dimension.databasePlugin.getUser("admin",!1).then((function(e){t.data.user=e,n()}));else n()},a.post("/register",(function(t,e,n){return t.body.username?t.body.password?void t.data.dimension.databasePlugin.registerUser(t.body.username,t.body.password,t.body.userData).then((function(){e.json({error:null,msg:"success"})})).catch(n):n(new o.BadRequest("Missing password")):n(new o.BadRequest("Missing username"))})),a.post("/login",(function(t,e,n){return t.body.username?t.body.password?void t.data.dimension.databasePlugin.loginUser(t.body.username,t.body.password).then((function(t){e.json({error:null,token:t})})).catch(n):n(new o.BadRequest("Missing password")):n(new o.BadRequest("Missing username"))})),a.post("/verify",(function(t,e,n){var r=t.get("Authorization");if(!r)return e.json({error:"Auth token must be specified",authenticated:!1});var i=r.split(" ");if(2!==i.length||"Bearer"!==i[0]||0===i[1].length)return e.json({error:"Invalid auth token format",authenticated:!1});t.data.dimension.databasePlugin.verifyToken(i[1]).then((function(){e.json({error:null})})).catch(n)})),e.default=a},6928:function(t,e,n){"use strict";var r=this&&this.__assign||function(){return(r=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)},i=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},s=this&&this.__generator||function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}},a=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e};Object.defineProperty(e,"__esModule",{value:!0});var u=o(n(7996)),c=a(n(3352)),l=a(n(5388)),h=a(n(4925)),f=n(6046),d=o(n(2065)),p=o(n(6577)),m=n(9822),g=o(n(5622)),y=n(5660),v=u.default.Router();v.get("/",(function(t,e){var n=t.app.get("dimensions"),r={};n.forEach((function(t){r[t.id]=_(t)})),e.json({error:null,dimensions:r})}));var _=function(t){var e=r(r({},f.pick(t,"configs","id","log","name","statistics")),{design:null}),n=function(t){var e=r({},f.pick(t,"log","name"));return e.designOptions=t.getDesignOptions(),e}(t.design);return e.design=n,e};v.use("/:id",(function(t,e,n){var r=t.params.id;if(!r)return n(new h.BadRequest("ID must be provided"));var i=t.app.get("dimensions").get(r);if(!i)return n(new h.BadRequest("No Dimension found"));t.data.dimension=i,n()})),v.get("/:id",(function(t,e){e.json({error:null,dimension:_(t.data.dimension)})})),v.use("/:id/match",c.default),v.get("/:id/match",(function(t,e){var n={};t.data.dimension.matches.forEach((function(t,e){n[e]=c.pickMatch(t)})),e.json({error:null,matches:n})})),v.post("/:id/match",(function(t,e,n){return i(void 0,void 0,void 0,(function(){var r,i,o;return s(this,(function(s){switch(s.label){case 0:return s.trys.push([0,3,,4]),[4,m.handleBotUpload(t)];case 1:return r=s.sent(),[4,t.data.dimension.createMatch(r)];case 2:return(i=s.sent()).run().then((function(){r.forEach((function(t){var e=t.file,n=g.default.dirname(e);y.removeDirectory(n)}))})).catch((function(){})),e.json({error:null,matchID:i.id}),[3,4];case 3:return o=s.sent(),[2,n(o)];case 4:return[2]}}))}))})),v.delete("/:id/match/:matchID",(function(t,e,n){return i(void 0,void 0,void 0,(function(){var r;return s(this,(function(i){switch(i.label){case 0:return i.trys.push([0,2,,3]),[4,t.data.dimension.removeMatch(t.params.matchID)];case 1:return i.sent(),e.json({error:null}),[3,3];case 2:return r=i.sent(),[2,n(new r.InternalServerError("Something went wrong"))];case 3:return[2]}}))}))})),v.get("/:id/tournaments",(function(t,e){var n={};t.data.dimension.tournaments.forEach((function(t){n[t.id]=l.pickTournament(t)})),e.json({error:null,tournaments:n})})),v.use("/:id/tournaments",l.default),e.requiresDatabase=function(t,e,n){var r=t.data.dimension;r.hasDatabase()?n():n(new h.InternalServerError("No database setup for dimension - ID: "+r.id+", name: "+r.name))},v.use("/:id/users",e.requiresDatabase),v.use("/:id/auth",e.requiresDatabase),v.use("/:id/users",d.default),v.use("/:id/auth",p.default),e.default=v},6358:function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},i=this&&this.__generator||function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},s=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}},o=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e};Object.defineProperty(e,"__esModule",{value:!0});var a=s(n(7996)),u=o(n(4925)),c=n(6046),l=a.default.Router();e.getAgent=function(t,e,n){var r=t.data.match.agents[parseInt(t.params.agentID)];if(!r)return n(new u.BadRequest("No agent found with id of '"+t.params.agentID+"' in match '"+t.data.match.id+"' in dimension "+t.data.dimension.id+" - '"+t.data.dimension.name+"'"));t.data.agent=r,n()},e.pickAgent=function(t){return c.pick(t,"id","name","tournamentID","logkey","version","status")},l.use("/:agentID",e.getAgent),l.get("/",(function(t,n){var r=t.data.match.agents.map((function(t){return e.pickAgent(t)}));n.json({error:null,agents:r})})),l.get("/:agentID",(function(t,n){n.json({error:null,agent:e.pickAgent(t.data.agent)})})),l.get("/:agentID/logs",(function(t,e,n){return r(void 0,void 0,void 0,(function(){var r,s;return i(this,(function(i){switch(i.label){case 0:return(r=t.data.agent).logkey?t.data.dimension.hasStorage()?[4,t.data.dimension.storagePlugin.getDownloadURL(r.logkey)]:[3,2]:[3,4];case 1:return s=i.sent(),e.json({error:null,url:s}),[3,3];case 2:e.sendFile(r.logkey),i.label=3;case 3:return[3,5];case 4:return[2,n(new u.BadRequest("No agent logs found"))];case 5:return[2]}}))}))})),e.default=l},3352:function(t,e,n){"use strict";var r=this&&this.__assign||function(){return(r=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)},i=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},s=this&&this.__generator||function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}},a=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e};Object.defineProperty(e,"__esModule",{value:!0});var u=o(n(7996)),c=a(n(4925)),l=n(578),h=n(6046),f=a(n(6358)),d=n(6577),p=u.default.Router();e.getMatch=function(t,e,n){return i(void 0,void 0,void 0,(function(){var e,r;return s(this,(function(i){switch(i.label){case 0:if(t.data.tournament)e=t.data.tournament.matches.get(t.params.matchID);else{if(!t.data.dimension)return[2,n(new c.BadRequest("System error. match API route was added out of order"))];e=t.data.dimension.matches.get(t.params.matchID)}if(e)return[3,4];if(!t.data.dimension.hasDatabase())return[3,4];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,t.data.dimension.databasePlugin.getMatch(t.params.matchID)];case 2:return e=i.sent(),[3,4];case 3:return r=i.sent(),[2,n(r)];case 4:return e?(t.data.match=e,n(),[2]):[2,n(new c.BadRequest("No match found with name or id of '"+t.params.matchID+"' in dimension "+t.data.dimension.id+" - '"+t.data.dimension.name+"'"))]}}))}))},e.pickMatch=function(t){var e=r(r({},h.pick(t,"configs","creationDate","id","mapAgentIDtoTournamentID","matchStatus","name","finishDate","results","replayFileKey","replayFile")),{agents:[]});return t.agents&&(e.agents=t.agents.map((function(t){return f.pickAgent(t)}))),e},p.use("/:matchID",e.getMatch),p.get("/:matchID",(function(t,n){n.json({error:null,match:e.pickMatch(t.data.match)})})),p.get("/:matchID/results",(function(t,e){e.json({error:null,results:t.data.match.results||null})})),p.get("/:matchID/replay",(function(t,e,n){return i(void 0,void 0,void 0,(function(){var r,i,o,a;return s(this,(function(s){switch(s.label){case 0:return t.data.dimension.hasStorage()?t.data.match.replayFileKey?(r=t.data.dimension.storagePlugin,o=(i=e).send,a={error:null},[4,r.getDownloadURL(t.data.match.replayFileKey)]):[3,2]:[3,4];case 1:return o.apply(i,[(a.url=s.sent(),a)]),[3,3];case 2:return[2,n(new c.BadRequest("Replay for this match does not exist or was not stored"))];case 3:return[3,5];case 4:if(!t.data.match.replayFile)return[2,n(new c.BadRequest("Replay file for this match does not exist or was not stored"))];e.sendFile(t.data.match.replayFile),s.label=5;case 5:return[2]}}))}))})),p.get("/:matchID/state",(function(t,e){e.json({error:null,state:t.data.match.state||null})})),p.post("/:matchID/run",d.requireAdmin,(function(t,e,n){return i(void 0,void 0,void 0,(function(){var r;return s(this,(function(i){switch(i.label){case 0:return i.trys.push([0,4,,5]),t.data.match.matchStatus!==l.Match.Status.FINISHED&&t.data.match.matchStatus!==l.Match.Status.UNINITIALIZED?[3,2]:[4,t.data.match.initialize()];case 1:return i.sent(),[3,3];case 2:if(t.data.match.matchStatus===l.Match.Status.RUNNING)return[2,n(new c.BadRequest("Match is already running"))];i.label=3;case 3:return t.data.match.matchStatus===l.Match.Status.STOPPED?t.data.match.resume():t.data.match.run().catch(h.noop),e.json({error:null,msg:"Running Match"}),[3,5];case 4:return r=i.sent(),[2,n(new r.InternalServerError("Match Failed to Run"))];case 5:return[2]}}))}))})),p.post("/:matchID/stop",d.requireAdmin,(function(t,e,n){return i(void 0,void 0,void 0,(function(){return s(this,(function(r){return t.data.match.matchStatus===l.Match.Status.STOPPED?[2,n(new c.BadRequest("Match is already stopped"))]:t.data.match.matchStatus===l.Match.Status.FINISHED?[2,n(new c.BadRequest("Match is already finished"))]:t.data.match.matchStatus===l.Match.Status.READY?[2,n(new c.BadRequest("Match hasn't started and can't be stopped as a result"))]:t.data.match.matchStatus===l.Match.Status.UNINITIALIZED?[2,n(new c.BadRequest("Can't stop an uninitialized match"))]:[2,t.data.match.stop().then((function(){e.json({error:null,msg:"Stopped Match"})})).catch((function(){return n(new c.InternalServerError("Couldn't stop the match"))}))]}))}))})),p.use("/:matchID/agents",f.default),e.default=p},5388:function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},i=this&&this.__generator||function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},s=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}},o=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e};Object.defineProperty(e,"__esModule",{value:!0});var a=s(n(7996)),u=o(n(4925)),c=n(5318),l=s(n(5622)),h=o(n(3352)),f=n(6046),d=n(6577),p=n(9822),m=n(7792),g=n(5660),y=n(3129),v=n(3549),_=a.default.Router();_.use("/:tournamentID",(function(t,e,n){var r=t.data.dimension.tournaments.get(t.params.tournamentID);if(!r)return n(new u.BadRequest("No tournament found with name or id of '"+t.params.tournamentID+"' in dimension "+t.data.dimension.id+" - '"+t.data.dimension.name+"'"));t.data.tournament=r,n()})),e.pickTournament=function(t){return f.pick(t,"configs","id","log","name","status")},_.get("/:tournamentID",(function(t,n){var r=e.pickTournament(t.data.tournament);n.json({error:null,tournament:r})})),_.use("/:tournamentID/match",h.default),_.get("/:tournamentID/match",(function(t,e){var n={};t.data.tournament.matches.forEach((function(t,e){n[e]=h.pickMatch(t)})),e.json({error:null,matches:n})})),_.get("/:tournamentID/match-queue",(function(t,e){e.json({error:null,matchQueue:t.data.tournament.matchQueue})})),_.post("/:tournamentID/configs",d.requireAdmin,(function(t,e,n){return r(void 0,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:if(!t.body.configs)return[2,n(new u.BadRequest("Missing configs"))];i.label=1;case 1:return i.trys.push([1,5,,6]),t.data.tournament.configs.type!==v.TournamentType.LADDER?[3,3]:[4,t.data.tournament.setConfigs(t.body.configs)];case 2:return i.sent(),e.json({error:null}),[3,4];case 3:t.data.tournament.setConfigs(t.body.configs),i.label=4;case 4:return[3,6];case 5:return r=i.sent(),[2,n(r)];case 6:return[2]}}))}))})),_.post("/:tournamentID/run",d.requireAdmin,(function(t,e,n){if(t.data.tournament.status===c.Tournament.Status.INITIALIZED)t.data.tournament.run({},!0).then((function(){e.json({error:null,msg:"Running Tournament"})})).catch(n);else{if(t.data.tournament.status!==c.Tournament.Status.STOPPED)return t.data.tournament.status===c.Tournament.Status.RUNNING?n(new u.BadRequest("Tournament is already running")):n(new u.BadRequest("Tournament cannot be run. Status is "+t.data.tournament.status));t.data.tournament.resume(!0).then((function(){e.json({error:null,msg:"Running Tournament"})})).catch(n)}})),_.post("/:tournamentID/stop",d.requireAdmin,(function(t,e,n){if(t.data.tournament.status!==c.Tournament.Status.RUNNING)return n(new u.BadRequest("Can't stop a tournament that isn't running"));t.data.tournament.stop(!0).then((function(){e.json({error:null,msg:"Stopped Tournament"})})).catch(n)})),_.get("/:tournamentID/ranks",(function(t,e,n){return r(void 0,void 0,void 0,(function(){var r,s,o;return i(this,(function(i){switch(i.label){case 0:return i.trys.push([0,5,,6]),r=[],s=parseInt(t.query.offset?t.query.offset:0),o=parseInt(t.query.limit?t.query.limit:-1),t.data.tournament.configs.type!==v.TournamentType.LADDER?[3,2]:[4,t.data.tournament.getRankings(s,o)];case 1:return r=i.sent(),[3,4];case 2:return[4,t.data.tournament.getRankings()];case 3:r=i.sent(),i.label=4;case 4:return e.json({error:null,ranks:r}),[3,6];case 5:return i.sent(),[2,n(new u.InternalServerError("Couldn't retrieve rankings"))];case 6:return[2]}}))}))})),_.delete("/:tournamentID/match/:matchID",d.requireAdmin,(function(t,e,n){return t.data.tournament.removeMatch(t.params.matchID).then((function(){e.json({error:null})})).catch((function(t){return n(new u.InternalServerError(t))}))})),_.delete("/:tournamentID/players/:playerID",d.requireAuth,(function(t,e,n){return t.data.dimension.databasePlugin.isAdmin(t.data.user)||t.params.playerID===t.data.user.playerID?t.data.tournament.removePlayer(t.params.playerID).then((function(){e.json({error:null})})).catch((function(e){return e instanceof m.TournamentPlayerDoesNotExistError?n(new u.BadRequest("Player with ID "+t.params.playerID+" does not exist")):n(new u.InternalServerError("Something went wrong: "+e.message))})):n(new u.Unauthorized("Insufficient permissions to delete this player"))})),_.get("/:tournamentID/players/:playerID",(function(t,e){return r(void 0,void 0,void 0,(function(){var n;return i(this,(function(r){switch(r.label){case 0:return[4,t.data.tournament.getPlayerStat(t.params.playerID)];case 1:return(n=r.sent().playerStat)?e.json({error:null,player:n}):e.json({error:null,player:null}),[2]}}))}))})),_.get("/:tournamentID/players/:playerID/match",(function(t,e,n){return r(void 0,void 0,void 0,(function(){var r,s,o;return i(this,(function(i){switch(i.label){case 0:if(!t.query.offset||!t.query.limit||!t.query.order)return[2,n(new u.BadRequest("Missing params"))];if(r=t.data.dimension.databasePlugin,!t.data.dimension.hasDatabase())return[3,5];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,r.getPlayerMatches(t.params.playerID,t.params.tournamentID,parseInt(t.query.offset),parseInt(t.query.limit),parseInt(t.query.order))];case 2:return s=i.sent(),e.json({error:null,matches:s}),[3,4];case 3:return o=i.sent(),[2,n(o)];case 4:return[3,6];case 5:return[2,n(new u.NotImplemented("Requires a database plugin in order to retrieve past matches"))];case 6:return[2]}}))}))})),_.get("/:tournamentID/players/:playerID/bot",d.requireAuth,(function(t,e,n){return r(void 0,void 0,void 0,(function(){var r;return i(this,(function(i){return t.data.dimension.databasePlugin.isAdmin(t.data.user)||t.params.playerID===t.data.user.playerID?(r=t.data.tournament,t.data.dimension.databasePlugin.getUser(t.params.playerID).then((function(n){var i=n.statistics[r.getKeyName()].player;if(t.data.dimension.hasStorage()){var s=i.botkey;t.data.dimension.storagePlugin.getDownloadURL(s).then((function(t){e.json({error:null,url:t})}))}else e.sendFile(i.zipFile)})).catch(n),[2]):[2,n(new u.Unauthorized("Insufficient permissions to retrieve this player"))]}))}))})),_.post("/:tournamentID/reset",d.requireAdmin,(function(t,e,n){return r(void 0,void 0,void 0,(function(){return i(this,(function(r){return t.data.tournament.configs.type!==v.TournamentType.LADDER?[2,n(new u.BadRequest("Can't reset a tournament that is not of the ladder type"))]:(t.data.tournament.resetRankings().then((function(){e.json({error:null,message:"ranks reset"})})).catch(n),[2])}))}))})),_.post("/:tournamentID/upload/",d.requireAuth,(function(t,e,n){return r(void 0,void 0,void 0,(function(){var r,s,o,a,c,h,f;return i(this,(function(i){switch(i.label){case 0:if(t.data.dimension.getStation().configs.disableUploads)return[2,n(new u.BadRequest("Uploads are disabled"))];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,p.handleBotUpload(t,t.data.user)];case 2:return r=i.sent(),[3,4];case 3:return s=i.sent(),[2,n(s)];case 4:return r.length>1?[2,n(new u.BadRequest("Can only upload one tournament bot at a time"))]:(o=r[0],a=o.playerID,c=t.data.user,t.data.dimension.hasDatabase()&&t.data.dimension.databasePlugin.isAdmin(t.data.user)?[4,t.data.dimension.databasePlugin.getUser(a)]:[3,6]);case 5:if(!(c=i.sent()))return[2,n(new u.BadRequest("Invalid player ID"))];i.label=6;case 6:return h=l.default.join(l.default.dirname(o.file),"bot.zip"),t.data.dimension.hasStorage()?[4,t.data.dimension.storagePlugin.uploadTournamentFile(o.originalFile,c,t.data.tournament)]:[3,8];case 7:return f=i.sent(),g.removeDirectorySync(l.default.dirname(o.file)),[3,9];case 8:y.spawnSync("cp",[o.originalFile,h]),i.label=9;case 9:return a||(a=t.data.tournament.generateNextTournamentIDString()),o.name||o.botdir||f?t.data.tournament.addplayer({file:o.file,name:o.name,zipFile:h,botdir:o.botdir,botkey:f},a):t.data.tournament.addplayer(o.file,a),e.json({error:null,message:"Successfully uploaded bot"}),[2]}}))}))})),_.post("/:tournamentID/upload-by-key",d.requireAuth,(function(t,e,n){return r(void 0,void 0,void 0,(function(){var r;return i(this,(function(i){switch(i.label){case 0:return t.data.dimension.hasStorage()?t.body.playerID?t.body.botkey?t.body.botname?t.body.pathtofile?(t.data.user,t.data.dimension.hasDatabase()&&t.data.dimension.databasePlugin.isAdmin(t.data.user)?[4,t.data.dimension.databasePlugin.getUser(t.body.playerID)]:[3,2]):[2,n(new u.BadRequest("Missing pathtofile"))]:[2,n(new u.BadRequest("Missing botname"))]:[2,n(new u.BadRequest("Missing botkey"))]:[2,n(new u.BadRequest("Missing player ID"))]:[2,n(new u.NotImplemented("Server does not have storage setup"))];case 1:if(!i.sent())return[2,n(new u.BadRequest("Invalid player ID"))];i.label=2;case 2:return i.trys.push([2,4,,5]),[4,t.data.tournament.addplayer({file:t.body.pathtofile,name:t.body.botname,zipFile:null,botdir:null,botkey:t.body.botkey},t.body.playerID)];case 3:return i.sent(),[3,5];case 4:return r=i.sent(),[2,n(new u.InternalServerError(r))];case 5:return e.json({error:null,message:"Succesfully uploaded bot"}),[2]}}))}))})),_.post("/:tournamentID/match-queue/",d.requireAdmin,(function(t,e,n){return r(void 0,void 0,void 0,(function(){var r;return i(this,(function(i){return t.body.matchQueue?t.body.matchQueue.length?(t.data.tournament.type===c.Tournament.Type.LADDER&&((r=t.data.tournament).scheduleMatches.apply(r,t.body.matchQueue),e.json({error:null,message:"Queued "+t.body.matchQueue.length+" matches"})),[2]):[2,n(new u.BadRequest("Must provide an array"))]:[2,n(new u.BadRequest("Missing matchQueue field"))]}))}))})),e.default=_},2065:function(t,e,n){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});var i=r(n(7996)),s=n(6577),o=i.default.Router();o.get("/:userid",s.storeAuth,(function(t,e,n){var r=t.data.dimension,i=!0;t.data.user&&(t.data.user.username!==t.params.userid&&t.data.user.playerID!==t.params.userid||(i=!1),t.data.dimension.databasePlugin.isAdmin(t.data.user)&&(i=!1)),r.databasePlugin.getUser(t.params.userid,i).then((function(t){e.json({error:null,user:t})})).catch(n)})),o.get("/",s.requireAuth,(function(t,e,n){t.data.dimension.databasePlugin.getUser(t.data.user.playerID,!1).then((function(t){e.json({error:null,user:t})})).catch(n)})),e.default=o},2099:function(t,e,n){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});var i=r(n(7996)).default.Router();i.get("/test",(function(t,e){return e.send("API online!")})),i.get("/dimensions",(function(t,e){e.json(t.app.get("dimensions")),e.send(JSON.stringify(e.app))})),e.default=i},4085:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(7792),i=function(){function t(t,e){this.kfactor=t,this.startingScore=e}return t.prototype.createRating=function(t){return void 0===t&&(t=this.startingScore),new s(t)},t.prototype.expectedScores1v1=function(t,e){var n=Math.pow(10,t.score/400),r=Math.pow(10,e.score/400);return[n/(n+r),r/(n+r)]},t.prototype.rate1v1=function(t,e,n){var r=this.expectedScores1v1(t,e),i=r[0],s=r[1];t.score=Math.round(t.score+this.kfactor*(n[0]-i)),e.score=Math.round(e.score+this.kfactor*(n[1]-s))},t.prototype.rate=function(t,e){if(e.length!=t.length)throw new r.FatalError("Ratings and ranks lengths do not match!");for(var n=[],i=[],s=0;s<t.length;s++)n.push(new Array(t.length)),i.push(0);for(s=0;s<t.length;s++)for(var o=s+1;o<t.length;o++){var a=this.expectedScores1v1(t[s],t[o]),u=a[0],c=a[1];n[s][o]=u,n[o][s]=c}for(s=0;s<t.length;s++){var l=0;for(o=0;o<t.length;o++)o!=s&&(l+=n[s][o],e[s]>e[o]?i[s]+=1:e[s]==e[o]&&(i[s]+=.5));t[s].score=Math.round(t[s].score+this.kfactor*(l-i[s]))}},t}();e.ELOWrapper=i;var s=function(t){this.score=t};e.ELORating=s},4057:function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),s=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},o=this&&this.__generator||function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};Object.defineProperty(e,"__esModule",{value:!0});var a=n(5318),u=n(2943),c=n(7792),l=function(t){function e(e,n,r,i,s){var o=t.call(this,e,i,r,s)||this;if(o.configs={defaultMatchConfigs:{},type:a.Tournament.Type.ELIMINATION,rankSystem:null,rankSystemConfigs:null,tournamentConfigs:{times:1,storePastResults:!0,lives:1,seeding:null},resultHandler:null,agentsPerMatch:[2],consoleDisplay:!0,id:"z3Ap49"},o.state={playerStats:new Map,statistics:{totalMatches:0},currentRound:null,results:[],resultsMap:new Map},o.matchHashes=[],o.type=a.Tournament.Type.ELIMINATION,o.shouldStop=!1,r.consoleDisplay&&(o.configs.consoleDisplay=r.consoleDisplay),o.configs=u.deepMerge(o.configs,r,!0),"string"!=typeof o.configs.rankSystem)throw new c.NotSupportedError("We do not support custom rank systems for elimination tournaments. Please pass in 'wins' or Tournament.RankSystemTypes.WINS instead");switch(r.rankSystem){case a.Tournament.RankSystemTypes.WINS:null===o.configs.rankSystemConfigs&&(o.configs.rankSystemConfigs={winValue:3,lossValue:0,tieValue:0,descending:!0});break;default:throw new c.NotSupportedError("We currently do not support this rank system for elimination tournaments")}return n.forEach((function(t){o.addplayer(t)})),o}return i(e,t),e.prototype.getConfigs=function(){return this.configs},e.prototype.setConfigs=function(t){void 0===t&&(t={}),this.configs=u.deepMerge(this.configs,t,!0)},e.prototype.getRankings=function(){return Array.from(this.state.playerStats).sort((function(t,e){return t[1].rank-e[1].rank})).map((function(t){return t[1]}))},e.prototype.stop=function(){var t=this;return new Promise((function(e,n){t.status!==a.Tournament.Status.RUNNING&&n(new c.TournamentError("Can't stop a tournament that isn't running")),t.log.info("Stopping Tournament..."),t.status=a.Tournament.Status.STOPPED,t.resumePromise=new Promise((function(e){t.resumeResolver=e})),t.shouldStop=!0,t.resolveStopPromise=e}))},e.prototype.resume=function(){return s(this,void 0,void 0,(function(){return o(this,(function(t){if(this.status!==a.Tournament.Status.STOPPED)throw new c.TournamentError("Can't resume a tournament that isn't stopped");return this.log.info("Resuming Tournament..."),this.status=a.Tournament.Status.RUNNING,this.resumeResolver(),[2]}))}))},e.prototype.run=function(t){return s(this,void 0,void 0,(function(){var e,n;return o(this,(function(r){switch(r.label){case 0:this.configs=u.deepMerge(this.configs,t,!0),this.initialize(),this.status=a.Tournament.Status.RUNNING,r.label=1;case 1:return this.matchQueue.length?this.shouldStop?(this.log.info("Stopped Tournament"),this.resolveStopPromise(),[4,this.resumePromise]):[3,3]:[3,5];case 2:r.sent(),this.log.info("Resumed Tournament"),this.shouldStop=!1,r.label=3;case 3:return e=this.matchQueue.shift(),n=this.matchHashes.shift(),[4,this.handleMatch(e,n)];case 4:return r.sent(),2===this.state.currentRound?[3,5]:(0===this.matchQueue.length&&this.generateRound(),[3,1]);case 5:return this.status=a.Tournament.Status.FINISHED,[2,this.state]}}))}))},e.prototype.handleMatch=function(t,e){return s(this,void 0,void 0,(function(){var n,r,i,s,a,u,l,h,f,d,p,m,g;return o(this,(function(o){switch(o.label){case 0:return[4,this.getMatchInfoFromQueuedMatch(t)];case 1:if(2!=(n=o.sent()).length)throw new c.FatalError("This shouldn't happen, tried to run a match with player count not equal to 2 in an elimination tournament");return null==n[0]?(r=n[1],this.state.resultsMap.set(e,{winner:r,loser:null}),[2]):null==n[1]?(i=n[0],this.state.resultsMap.set(e,{winner:i,loser:null}),[2]):(this.log.detail("Running match - Competitors: ",n.map((function(t){return t.tournamentID.name}))),[4,this.runMatch(n)]);case 2:return s=o.sent(),a=this.configs.resultHandler(s.results),this.configs.tournamentConfigs.storePastResults&&(this.dimension.hasDatabase()&&this.dimension.databasePlugin.configs.saveTournamentMatches||this.state.results.push(a)),this.state.statistics.totalMatches++,u=this.configs.rankSystemConfigs,l={},h=n[0].tournamentID.id,f=n[1].tournamentID.id,l[h]=0,l[f]=0,a.ranks.sort((function(t,e){return t.rank-e.rank})),a.ranks[0].rank===a.ranks[1].rank?a.ranks.forEach((function(t){var e=s.match.mapAgentIDtoTournamentID.get(t.agentID);l[e.id]+=u.tieValue})):(d=s.match.mapAgentIDtoTournamentID.get(a.ranks[0].agentID),p=s.match.mapAgentIDtoTournamentID.get(a.ranks[1].agentID),l[d.id]+=u.winValue,l[p.id]+=u.lossValue),m=this.state.playerStats.get(h),g=this.state.playerStats.get(f),(l[h]<l[f]||l[h]===l[f]&&Math.random()>.5)&&(m=this.state.playerStats.get(f),g=this.state.playerStats.get(h)),m.wins++,m.matchesPlayed++,g.losses++,g.matchesPlayed++,g.rank=this.state.currentRound,this.state.resultsMap.set(e,{winner:m.player,loser:g.player}),[2]}}))}))},e.prototype.initialize=function(){var t=this;switch(this.state.playerStats=new Map,this.state.results=[],this.configs.rankSystem){case a.Tournament.RankSystemTypes.WINS:var e=this.configs.tournamentConfigs.seeding;if(null==e&&(e=[]),e.length>this.competitors.size)throw new c.TournamentError("Seeds provided cannot be greater than the number of competitors");for(var n=0;n<this.competitors.size-e.length;n++)e.push(null);var r=new Set;for(n=0;n<this.competitors.size;n++)r.add(n+1);for(n=0;n<e.length;n++)if(null!=e[n]){if(!r.has(e[n]))throw new c.TournamentError("Duplicate seeds are not allowed. There are duplicate seeds of "+e[n]);r.delete(e[n])}var i=Array.from(r);i=this.shuffle(i),this.competitors.forEach((function(n,r){var s=e[r],o={player:n,wins:0,losses:0,matchesPlayed:0,seed:null!=s?s:i.shift(),rank:1};t.state.playerStats.set(n.tournamentID.id,o)}))}var s=Math.ceil(Math.log2(this.competitors.size)),o=Math.pow(2,s);this.state.currentRound=o,this.generateFirstRounds(),this.status=a.Tournament.Status.INITIALIZED},e.prototype.generateFirstRounds=function(){for(var t=this.state.currentRound,e=Array.from(this.state.playerStats).sort((function(t,e){return t[1].seed-e[1].seed})),n=0;n<t/2;n++){var r=e[n][1].player,i=t-(n+1),s=null;e.length>i&&(s=e[i][1].player),this.matchQueue.push([r.tournamentID.id,s.tournamentID.id]),this.matchHashes.push(n+1+","+(i+1))}},e.prototype.generateRound=function(){for(var t=this.state.currentRound,e=Math.floor(t/2),n=[],r=0;r<e/2;r++){var i=e-(r+1);n.push([r+1,i+1])}for(r=0;r<n.length;r++){var s=n[r],o=t-s[0]+1,a=this.state.resultsMap.get(s[0]+","+o).winner,u=t-s[1]+1,c=this.state.resultsMap.get(s[1]+","+u).winner;this.matchHashes.push(s[0]+","+s[1]),this.matchQueue.push([a.tournamentID.id,c.tournamentID.id])}this.state.currentRound=e},e.prototype.shuffle=function(t){for(var e=t.length-1;e>=1;e--){var n=Math.floor(Math.random()*e),r=t[e];t[e]=t[n],t[n]=r}return t},e.prototype.internalAddPlayer=function(){return s(this,void 0,void 0,(function(){return o(this,(function(t){if(this.status===a.Tournament.Status.INITIALIZED||this.status===a.Tournament.Status.RUNNING)throw new c.TournamentError("You are not allowed to add a player during the middle or after initialization of elimination tournaments");return[2]}))}))},e.prototype.updatePlayer=function(){return s(this,void 0,void 0,(function(){return o(this,(function(t){throw new c.TournamentError("You are not allowed to update a player during elimination tournaments")}))}))},e}(a.Tournament);e.Elimination=l},3872:function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),s=this&&this.__assign||function(){return(s=Object.assign||function(t){for(var e,n=1,r=arguments.length;n<r;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)},o=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},a=this&&this.__generator||function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};Object.defineProperty(e,"__esModule",{value:!0});var u=n(5318),c=n(2943),l=n(7792),h=n(8579),f=n(7422),d=n(3549),p=n(3338),m=n(6063),g=n(8234),y=n(1170),v=n(9484),_=function(t){function e(e,n,r,i,s){var o=t.call(this,e,i,r,s)||this;if(o.configs={defaultMatchConfigs:{},type:d.TournamentType.LADDER,rankSystem:null,rankSystemConfigs:null,tournamentConfigs:{maxConcurrentMatches:1,endDate:null,storePastResults:!0,maxTotalMatches:null,matchMake:null,configSyncRefreshRate:6e3,syncConfigs:!0,selfMatchMake:!0},resultHandler:null,agentsPerMatch:[2],consoleDisplay:!0,id:"z3plg"},o.state={playerStats:new Map,currentRanks:[],results:[],statistics:{totalMatches:0}},o.type=u.Tournament.Type.LADDER,o.matchQueueLocked=!1,o.runInterval=null,o.configSyncInterval=null,o.configLastModificationDate=new Date(0),o.resultProcessingQueue=[],o.configs=c.deepMerge(o.configs,r,!0),"string"==typeof o.configs.rankSystem)switch(null===o.configs.rankSystemConfigs&&(o.configs.rankSystemConfigs={}),o.configs.rankSystem){case u.Tournament.RankSystemTypes.TRUESKILL:o.ranksystem=new p.TrueSkillSystem(o.configs.rankSystemConfigs);break;case u.Tournament.RankSystemTypes.ELO:o.ranksystem=new m.ELOSystem(o.configs.rankSystemConfigs);break;case u.Tournament.RankSystemTypes.WINS:o.ranksystem=new v.WinsSystem(o.configs.rankSystemConfigs);break;default:throw new l.NotSupportedError("We currently do not support this rank system for ladder tournaments")}else o.ranksystem=o.configs.rankSystem;if(null===o.ranksystem)throw new l.FatalError("Did not supply a rank system");if(n.forEach((function(t){"string"==typeof t?o.initialAddPlayerPromises.push(o.addplayer(t,void 0,!0)):o.initialAddPlayerPromises.push(o.addplayer(t,t.existingID,!0))})),Promise.all(o.initialAddPlayerPromises).then((function(){o.emit(u.Tournament.Events.INITIAL_PLAYERS_INITIALIZED)})),o.status=f.TournamentStatus.INITIALIZED,o.dimension.hasDatabase()&&o.configs.tournamentConfigs.syncConfigs&&(o.syncConfigs(),o.setupConfigSyncInterval(),o.dimension.databasePlugin.getTournamentConfigs(o.id).then((function(t){t||(o.configLastModificationDate=new Date,o.dimension.databasePlugin.storeTournamentConfigs(o.id,o.getConfigsStrippedOfFunctionFields(o.configs),o.status).then((function(){o.log.info("Storing initial tournament configuration data")})))}))),!o.configs.tournamentConfigs.matchMake){var a=o.configs.agentsPerMatch[0];o.configs.agentsPerMatch.forEach((function(t){a=Math.max(a,t)})),o.configs.tournamentConfigs.matchMake=y.Scheduler.RankRangeRandom({agentsPerMatch:o.configs.agentsPerMatch,range:Math.ceil(2.5*a)})}return o.log.info("Initialized Ladder Tournament"),o}return i(e,t),e.prototype.getConfigsStrippedOfFunctionFields=function(t){var e=g.deepCopy(t);return delete e.resultHandler,delete e.rankSystem,delete e.tournamentConfigs.matchMake,e},e.prototype.syncConfigs=function(){return o(this,void 0,void 0,(function(){var t,e,n,r;return a(this,(function(i){switch(i.label){case 0:return[4,this.dimension.databasePlugin.getTournamentConfigsModificationDate(this.id)];case 1:return(t=i.sent())&&t.getTime()>this.configLastModificationDate.getTime()?[4,this.dimension.databasePlugin.getTournamentConfigs(this.id)]:[3,3];case 2:e=i.sent(),n=e.configs,r=e.status,this.log.info("Received new configurations, mod date - "+t),this.log.detail(n),this.configLastModificationDate=t,this.configs=c.deepMerge(this.configs,n,!0),r!==this.status&&(r===u.Tournament.Status.STOPPED?this.status===u.Tournament.Status.RUNNING&&this.stop():r===u.Tournament.Status.RUNNING&&(this.status===u.Tournament.Status.INITIALIZED?this.run():this.status===u.Tournament.Status.STOPPED&&this.resume())),i.label=3;case 3:return[2]}}))}))},e.prototype.setupConfigSyncInterval=function(){var t=this;this.configSyncInterval=setInterval((function(){t.syncConfigs()}),this.configs.tournamentConfigs.configSyncRefreshRate)},e.prototype.getConfigs=function(){return this.configs},e.prototype.setStatus=function(t){return o(this,void 0,void 0,(function(){return a(this,(function(e){switch(e.label){case 0:return this.dimension.hasDatabase()&&this.configs.tournamentConfigs.syncConfigs?[4,this.syncConfigs()]:[3,3];case 1:return e.sent(),[4,this.dimension.databasePlugin.storeTournamentConfigs(this.id,this.getConfigsStrippedOfFunctionFields(this.configs),t)];case 2:return e.sent(),this.status=t,[3,4];case 3:this.status=t,e.label=4;case 4:return[2]}}))}))},e.prototype.setConfigs=function(t){return void 0===t&&(t={}),o(this,void 0,void 0,(function(){var e,n=this;return a(this,(function(r){if(t.id)throw new l.TournamentError("You cannot change the tournament ID after constructing the tournament");if(t.rankSystem)throw new l.TournamentError("You cannot change the rank system after constructing the tournament");return this.dimension.hasDatabase()&&this.configs.tournamentConfigs.syncConfigs?(e=this.dimension.databasePlugin,this.syncConfigs().then((function(){var r=c.deepMerge(g.deepCopy(n.configs),t,!0);e.storeTournamentConfigs(n.id,n.getConfigsStrippedOfFunctionFields(r),n.status).then((function(){n.configs=r}))}))):this.configs=c.deepMerge(this.configs,t,!0),[2]}))}))},e.prototype.getRankings=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=-1),o(this,void 0,void 0,(function(){var n,r,i,s=this;return a(this,(function(o){switch(o.label){case 0:return n=[],this.dimension.hasDatabase()?[4,this.dimension.databasePlugin.getUsersInTournament(this.getKeyName(),0,-1)]:[3,2];case 1:return r=o.sent(),n=r.map((function(t){var e=t.statistics[s.getKeyName()],n=e.rankState;return{player:e.player,matchesPlayed:e.matchesPlayed,rankState:n}})),this.anonymousCompetitors.size>0&&this.anonymousCompetitors.forEach((function(t){var e=s.state.playerStats.get(t.tournamentID.id),r=e.rankState;n.push({player:e.player,matchesPlayed:e.matchesPlayed,rankState:r})})),[3,3];case 2:this.state.playerStats.forEach((function(t){n.push({player:t.player,matchesPlayed:t.matchesPlayed,rankState:t.rankState})})),o.label=3;case 3:return n.sort((function(t,e){return s.ranksystem.rankComparator(t.rankState,e.rankState)})),i=-1===e?n.length:t+e,[2,n.slice(t,i)]}}))}))},e.prototype.resetRankings=function(){return o(this,void 0,void 0,(function(){var t,e,n,r=this;return a(this,(function(i){switch(i.label){case 0:if(this.status==f.TournamentStatus.RUNNING)throw new l.TournamentError("Cannot reset while tournament is running!");return t=[],e=[],n=[],this.dimension.hasDatabase()?[4,this.dimension.databasePlugin.getUsersInTournament(this.getKeyName(),0,-1)]:[3,2];case 1:return n=i.sent(),(e=n.map((function(t){return t.statistics[r.getKeyName()]}))).push.apply(e,Array.from(this.state.playerStats.values())),[3,3];case 2:e=Array.from(this.state.playerStats.values()),i.label=3;case 3:return e.forEach((function(e,i){t.push(o(r,void 0,void 0,(function(){return a(this,(function(t){switch(t.label){case 0:return e.matchesPlayed=0,e.rankState=this.ranksystem.resetRank(e.rankState),this.dimension.hasDatabase()?[4,this.updateDatabasePlayerStats(e,n[i])]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))})))})),[4,Promise.all(t)];case 4:return i.sent(),[2]}}))}))},e.prototype.stop=function(t){return void 0===t&&(t=!1),o(this,void 0,void 0,(function(){return a(this,(function(e){switch(e.label){case 0:if(this.status!==f.TournamentStatus.RUNNING)throw new l.TournamentError("Can't stop a tournament that isn't running");return this.log.info("Stopping Tournament..."),clearInterval(this.runInterval),t?[4,this.setStatus(f.TournamentStatus.STOPPED)]:[3,2];case 1:return e.sent(),[3,3];case 2:this.status=f.TournamentStatus.STOPPED,e.label=3;case 3:return[2]}}))}))},e.prototype.resume=function(t){return void 0===t&&(t=!1),o(this,void 0,void 0,(function(){var e=this;return a(this,(function(n){switch(n.label){case 0:if(this.status!==f.TournamentStatus.STOPPED)throw new l.TournamentError("Can't resume a tournament that isn't stopped");return this.log.info("Resuming Tournament..."),t?[4,this.setStatus(f.TournamentStatus.RUNNING)]:[3,2];case 1:return n.sent(),[3,3];case 2:this.status=f.TournamentStatus.RUNNING,n.label=3;case 3:return this.tourneyRunner(),this.runInterval=setInterval((function(){e.tourneyRunner()}),1e4),[2]}}))}))},e.prototype.run=function(t,e){return void 0===e&&(e=!1),o(this,void 0,void 0,(function(){var n=this;return a(this,(function(r){switch(r.label){case 0:return this.log.info("Running Tournament"),this.configs=c.deepMerge(this.configs,t,!0),[4,this.initialize()];case 1:return r.sent(),this.configs.tournamentConfigs.selfMatchMake?[4,this.schedule()]:[3,3];case 2:return r.sent(),[3,4];case 3:this.log.info("Self match make turned off, tournament will only run matches stored in match queue"),r.label=4;case 4:return e?this.setStatus(f.TournamentStatus.RUNNING):this.status=f.TournamentStatus.RUNNING,this.tourneyRunner(),this.runInterval=setInterval((function(){n.tourneyRunner()}),1e4),[2]}}))}))},e.prototype.tourneyRunner=function(){return o(this,void 0,void 0,(function(){var t,e,n,r,i=this;return a(this,(function(s){switch(s.label){case 0:return this.matchQueueLocked?[2]:(this.matchQueueLocked=!0,this.matches.size>=this.configs.tournamentConfigs.maxConcurrentMatches?(this.matchQueueLocked=!1,[2]):(t=this.configs.tournamentConfigs.maxTotalMatches,this.configs.tournamentConfigs.endDate&&(new Date).getTime()>this.configs.tournamentConfigs.endDate.getTime()?(this.log.info("Reached past Tournament marked End Date, shutting down tournament..."),this.stop(),[2]):t&&this.state.statistics.totalMatches>=t?(this.log.info("Reached max matches, shutting down tournament..."),this.stop(),this.matchQueueLocked=!1,[2]):(e=[],this.configs.tournamentConfigs.selfMatchMake&&this.matchQueue.length<2*this.configs.tournamentConfigs.maxConcurrentMatches?[4,this.schedule()]:[3,2])));case 1:s.sent(),s.label=2;case 2:for(n=0;n<Math.min(this.matchQueue.length,this.configs.tournamentConfigs.maxConcurrentMatches-this.matches.size)&&!(t&&t-this.state.statistics.totalMatches-this.matches.size<=0);n++)r=this.matchQueue.shift(),e.push(this.handleMatch(r));return Promise.race(e).then((function(){i.status==f.TournamentStatus.RUNNING&&i.tourneyRunner()})).catch((function(t){i.log.error(t),l.MatchDestroyedError,i.status==f.TournamentStatus.RUNNING&&i.tourneyRunner()})),this.matchQueueLocked=!1,[2]}}))}))},e.prototype.updateDatabasePlayerStats=function(t,e){return o(this,void 0,void 0,(function(){var n,r,i,o,u;return a(this,(function(a){switch(a.label){case 0:if((n=t.player).anonymous)return[3,4];r=this.getKeyName(),i={statistics:{}},e&&e.statistics&&(i.statistics=e.statistics),o={},Object.entries(n).forEach((function(t){var e=t[0],n=t[1];o[e]=n})),i.statistics[r]=s(s({},t),{player:o}),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,this.dimension.databasePlugin.updateUser(n.tournamentID.id,i)];case 2:return a.sent(),[3,4];case 3:return u=a.sent(),this.log.error("Failed to update user with player stats",u),[3,4];case 4:return[2]}}))}))},e.prototype.initializePlayerStats=function(t){return o(this,void 0,void 0,(function(){var e,n,r;return a(this,(function(i){switch(i.label){case 0:return e=null,r=this.getKeyName(),t.anonymous||!this.dimension.hasDatabase()?[3,2]:[4,this.dimension.databasePlugin.getUser(t.tournamentID.id)];case 1:if((n=i.sent())&&n.statistics&&(e=n.statistics[r]))return[2];i.label=2;case 2:return e?[3,4]:(e={player:t,matchesPlayed:0,rankState:this.ranksystem.initializeRankState()},[4,this.updateDatabasePlayerStats(e,n)]);case 3:i.sent(),i.label=4;case 4:return n||this.state.playerStats.set(t.tournamentID.id,e),[2]}}))}))},e.prototype.initialize=function(){return o(this,void 0,void 0,(function(){var t,e=this;return a(this,(function(n){switch(n.label){case 0:return[4,Promise.all(this.initialAddPlayerPromises)];case 1:return n.sent(),this.state.playerStats=new Map,this.state.results=[],t=[],this.competitors.forEach((function(n){t.push(e.initializePlayerStats(n))})),[4,Promise.all(t)];case 2:return n.sent(),this.configs.consoleDisplay?[4,this.printTournamentStatus()]:[3,4];case 3:n.sent(),n.label=4;case 4:return[2]}}))}))},e.prototype.schedule=function(){return o(this,void 0,void 0,(function(){var t,e,n;return a(this,(function(r){switch(r.label){case 0:return[4,this.getRankings(0,-1)];case 1:return t=r.sent(),this.configs.tournamentConfigs.matchMake?(e=this.configs.tournamentConfigs.matchMake(t),(n=this.matchQueue).push.apply(n,e),[2]):[2]}}))}))},e.prototype.scheduleMatches=function(){for(var t,e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];(t=this.matchQueue).push.apply(t,e),this.tourneyRunner()},e.prototype.internalAddPlayer=function(t){return o(this,void 0,void 0,(function(){return a(this,(function(e){switch(e.label){case 0:return[4,this.initializePlayerStats(t)];case 1:return e.sent(),[2]}}))}))},e.prototype.updatePlayer=function(t){return o(this,void 0,void 0,(function(){var e,n,r,i;return a(this,(function(s){switch(s.label){case 0:return[4,this.getPlayerStat(t.tournamentID.id)];case 1:return e=s.sent(),n=e.user,r=e.playerStat,(i=r).player=t,i.matchesPlayed=0,i.rankState=this.ranksystem.onPlayerUpdate(i.rankState),this.dimension.hasDatabase()?t.anonymous?[3,3]:[4,this.updateDatabasePlayerStats(i,n)]:[3,3];case 2:s.sent(),s.label=3;case 3:return[2]}}))}))},e.prototype.internalRemovePlayer=function(t){return o(this,void 0,void 0,(function(){var e,n,r,i;return a(this,(function(s){switch(s.label){case 0:return[4,this.getPlayerStat(t)];case 1:return e=s.sent(),n=e.user,e.playerStat?(this.state.playerStats.delete(t),this.log.info("Removed player "+t),this.dimension.hasDatabase()&&n?(r=this.getKeyName(),i={statistics:{}},n&&n.statistics&&(i.statistics=n.statistics),delete i.statistics[r],[4,this.dimension.databasePlugin.updateUser(t,i)]):[3,3]):[3,4];case 2:s.sent(),this.log.info("Removed player "+t+" from DB"),s.label=3;case 3:return[3,5];case 4:throw new l.TournamentPlayerDoesNotExistError("Could not find player with ID: "+t);case 5:return[2]}}))}))},e.prototype.printTournamentStatus=function(){return o(this,void 0,void 0,(function(){var t,e=this;return a(this,(function(n){switch(n.label){case 0:return this.log.level>h.Logger.LEVEL.NONE?[4,this.getRankings(0,-1)]:[3,2];case 1:t=n.sent(),console.clear(),console.log(this.log.bar()),console.log("Tournament - ID: "+this.id+", Name: "+this.name+" | Dimension - ID: "+this.dimension.id+", Name: "+this.dimension.name+"\nStatus: "+this.status+" | Competitors: "+this.competitors.size+" | Rank System: "+this.configs.rankSystem+"\n"),console.log("Total Matches: "+this.state.statistics.totalMatches+" | Matches Queued: "+this.matchQueue.length),console.log(this.ranksystem.getRankStatesHeaderString()),t.forEach((function(t){console.log(e.ranksystem.getRankStateString(t.player,t.rankState,t.matchesPlayed))})),console.log(),console.log("Current Matches: "+this.matches.size),this.matches.forEach((function(t){var e=[];t.agents.forEach((function(t){e.push(t.name)})),console.log(e)})),n.label=2;case 2:return[2]}}))}))},e.prototype.checkMatchIntegrity=function(t){return o(this,void 0,void 0,(function(){var e,n,r,i,s=this;return a(this,(function(u){for(e=function(t){return o(s,void 0,void 0,(function(){var e;return a(this,(function(n){switch(n.label){case 0:return[4,this.getPlayerStat(t)];case 1:return(e=n.sent()).playerStat?e.playerStat.player.disabled?[2,!1]:[2,!0]:[2,!1]}}))}))},n=[],r=0;r<t.length;r++)i=t[r],n.push(e(i.tournamentID.id));return[2,Promise.all(n).then((function(t){for(var e=0;e<t.length;e++)if(!1===t[e])return!1;return!0}))]}))}))},e.prototype.handleMatch=function(t){return o(this,void 0,void 0,(function(){var e,n,r,i;return a(this,(function(s){switch(s.label){case 0:return[4,this.getMatchInfoFromQueuedMatch(t)];case 1:return e=s.sent(),[4,this.checkMatchIntegrity(e)];case 2:return s.sent()?this.configs.consoleDisplay?[4,this.printTournamentStatus()]:[3,4]:(this.log.detail("Match queued cannot be run anymore"),[2]);case 3:s.sent(),s.label=4;case 4:return this.log.detail("Running match - Competitors: ",e.map((function(t){return t.tournamentID.name}))),[4,this.runMatch(e)];case 5:return(n=s.sent()).err?n.err instanceof l.AgentCompileError?(r=n.match.mapAgentIDtoTournamentID.get(n.err.agentID),this.log.warn("Match couldn't run. Player "+r.id+" got a compile error"),[4,this.disablePlayer(r.id)]):[3,7]:[3,11];case 6:return s.sent(),[3,10];case 7:return n.err instanceof l.AgentInstallError?(r=n.match.mapAgentIDtoTournamentID.get(n.err.agentID),this.log.warn("Match couldn't run. Player "+r.id+" got an install error"),[4,this.disablePlayer(r.id)]):[3,9];case 8:return s.sent(),[3,10];case 9:this.log.error("Match couldn't run, aborting... ",n.err),s.label=10;case 10:return this.matches.delete(n.match.id),[2];case 11:return this.state.statistics.totalMatches++,i=this.configs.resultHandler(n.results),this.resultProcessingQueue.push({result:i,mapAgentIDtoTournamentID:n.match.mapAgentIDtoTournamentID}),this.handleMatchResults(),this.configs.tournamentConfigs.storePastResults&&(this.dimension.hasDatabase()&&this.dimension.databasePlugin.configs.saveTournamentMatches||this.state.results.push(n.results)),[2]}}))}))},e.prototype.updatePlayerStat=function(t){return o(this,void 0,void 0,(function(){var e,n;return a(this,(function(r){switch(r.label){case 0:return t.player.anonymous?(this.state.playerStats.set(t.player.tournamentID.id,t),[3,6]):[3,1];case 1:return r.trys.push([1,5,,6]),[4,this.dimension.databasePlugin.getUser(t.player.tournamentID.id)];case 2:return(e=r.sent())&&e.statistics[this.getKeyName()]?[4,this.updateDatabasePlayerStats(t,e)]:[3,4];case 3:r.sent(),r.label=4;case 4:return[3,6];case 5:return n=r.sent(),this.log.error("Issue with using database",n),[3,6];case 6:return[2]}}))}))},e.prototype.handleMatchResults=function(){return o(this,void 0,void 0,(function(){var t,e,n,r,i,s,c,h,f,d,p=this;return a(this,(function(m){switch(m.label){case 0:if(t=this.resultProcessingQueue.shift(),e=t.mapAgentIDtoTournamentID,0===(n=t.result).ranks.length)return this.emit(u.Tournament.Events.MATCH_HANDLED),[2];n.ranks.sort((function(t,e){return t.rank-e.rank})),r=[],i=[],s=[],c=[],n.ranks.forEach((function(t){r.push(o(p,void 0,void 0,(function(){var n,r,o;return a(this,(function(a){switch(a.label){case 0:return n=e.get(t.agentID),[4,this.getPlayerStat(n.id)];case 1:if(!(r=a.sent().playerStat))throw new l.TournamentPlayerDoesNotExistError("Player "+n.id+" doesn't exist anymore, likely was removed");return(o=r).matchesPlayed++,i.push(t.rank),c.push({id:n,stats:o}),s.push(o.rankState),[2]}}))})))})),m.label=1;case 1:return m.trys.push([1,3,,4]),[4,Promise.all(r)];case 2:return m.sent(),[3,4];case 3:return h=m.sent(),this.log.error("Probably due to player being removed: ",h),this.emit(u.Tournament.Events.MATCH_HANDLED),[2];case 4:return f=this.ranksystem.updateRanks(s,i),d=[],c.forEach((function(t,e){d.push(o(p,void 0,void 0,(function(){var n;return a(this,(function(r){switch(r.label){case 0:return(n=t.stats).rankState=f[e],[4,this.updatePlayerStat(n)];case 1:return r.sent(),[2]}}))})))})),[4,Promise.all(d)];case 5:return m.sent(),this.configs.consoleDisplay?[4,this.printTournamentStatus()]:[3,7];case 6:m.sent(),m.label=7;case 7:return this.emit(u.Tournament.Events.MATCH_HANDLED),[2]}}))}))},e.prototype.preInternalDestroy=function(){return o(this,void 0,void 0,(function(){return a(this,(function(t){return this.runInterval&&clearInterval(this.runInterval),this.configSyncInterval&&clearInterval(this.configSyncInterval),[2]}))}))},e}(u.Tournament);e.Ladder=_},6063:function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var s=n(1180),o=n(2943),a=n(8234),u=n(4085),c=function(t){function e(e){var n=t.call(this)||this;return n.configs={startingScore:1e3,kFactor:32},n.configs=o.deepMerge(n.configs,a.deepCopy(e)),n.elo=new u.ELOWrapper(n.configs.kFactor,n.configs.startingScore),n}return i(e,t),e.prototype.initializeRankState=function(){return{rating:this.elo.createRating()}},e.prototype.onPlayerUpdate=function(t){return{rating:this.elo.createRating(t.rating.score)}},e.prototype.updateRanks=function(t,e){var n=this,r=[];return t.forEach((function(t){r.push(n.elo.createRating(t.rating.score))})),this.elo.rate(r,e),r.map((function(t){return{rating:t}}))},e.prototype.resetRank=function(t){return{rating:this.elo.createRating()}},e.prototype.rankComparator=function(t,e){return e.rating.score-t.rating.score},e.prototype.getRankStatesHeaderString=function(){return s.sprintf("%-30s | %-15s | %-15s | %-8s".underline,"Name","ID","ELO Score","Matches")},e.prototype.getRankStateString=function(t,e,n){return s.sprintf("%-30s".blue+" | %-15s | "+"%-15s".green+" | %-8s",t.tournamentID.name,t.tournamentID.id,e.rating.score,n)},e}(n(8147).RankSystem);e.ELOSystem=c},3338:function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var s=n(1180),o=n(5154),a=n(2943),u=n(8234),c=function(t){function e(e){var n=t.call(this)||this;return n.configs={initialMu:25,initialSigma:25/3},n.configs=a.deepMerge(n.configs,u.deepCopy(e)),n}return i(e,t),e.prototype.initializeRankState=function(){return{rating:{mu:this.configs.initialMu,sigma:this.configs.initialSigma,score:this.getScore(this.configs.initialMu,this.configs.initialSigma)}}},e.prototype.getScore=function(t,e){return t-3*e},e.prototype.onPlayerUpdate=function(t){return{rating:{mu:t.rating.mu,sigma:this.configs.initialSigma,score:this.getScore(t.rating.mu,this.configs.initialSigma)}}},e.prototype.updateRanks=function(t,e){var n=this,r=[];t.forEach((function(t){r.push([new o.Rating(t.rating.mu,t.rating.sigma)])}));var i=o.rate(r,e),s=[];return i.forEach((function(t){s.push({rating:{mu:t[0].mu,sigma:t[0].sigma,score:n.getScore(t[0].mu,t[0].sigma)}})})),s},e.prototype.resetRank=function(t){return{rating:{mu:this.configs.initialMu,sigma:this.configs.initialSigma,score:this.getScore(this.configs.initialMu,this.configs.initialSigma)}}},e.prototype.rankComparator=function(t,e){return e.rating.score-t.rating.score},e.prototype.getRankStatesHeaderString=function(){return s.sprintf("%-30s | %-14s | %-15s | %-18s | %-8s".underline,"Name","ID","Score=( - 3)","Mu: , Sigma: ","Matches")},e.prototype.getRankStateString=function(t,e,n){return s.sprintf("%-30s".blue+" | %-14s | "+"%-15s".green+" | "+"=%-6s, =%-6s".yellow+" | %-8s",t.tournamentID.name+(t.disabled?" X":""),t.tournamentID.id,(e.rating.mu-3*e.rating.sigma).toFixed(7),e.rating.mu.toFixed(3),e.rating.sigma.toFixed(3),n)},e}(n(8147).RankSystem);e.TrueSkillSystem=c},9484:function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var s=n(1180),o=n(2943),a=n(8234),u=n(8147),c=n(7792),l=function(t){function e(e){var n=t.call(this)||this;return n.configs={winValue:3,tieValue:1,lossValue:0,descending:!0},n.configs=o.deepMerge(n.configs,a.deepCopy(e)),n}return i(e,t),e.prototype.getPoints=function(t,e,n){return t*this.configs.winValue+e*this.configs.tieValue+n*this.configs.lossValue},e.prototype.initializeRankState=function(){return{wins:0,losses:0,ties:0,points:this.getPoints(0,0,0)}},e.prototype.onPlayerUpdate=function(t){return{wins:0,losses:0,ties:0,points:this.getPoints(0,0,0)}},e.prototype.updateRanks=function(t,e){var n=this;if(e.length>2||t.length>2)throw new c.FatalError("WinsSystem only supports 2 agent matches");if(e[0]===e[1])return t.map((function(t){return{wins:t.wins,ties:t.ties+1,losses:t.losses,points:n.getPoints(t.wins,t.ties+1,t.losses)}}));var r=0,i=1;return e[0]>e[1]&&(r=1,i=0),[{wins:t[r].wins+1,ties:t[r].ties,losses:t[r].losses,points:this.getPoints(t[r].wins+1,t[r].ties,t[r].losses)},{wins:t[i].wins,ties:t[i].ties,losses:t[i].losses+1,points:this.getPoints(t[i].wins,t[i].ties,t[i].losses+1)}]},e.prototype.resetRank=function(t){return{wins:0,ties:0,losses:0,points:this.getPoints(0,0,0)}},e.prototype.rankComparator=function(t,e){return this.configs.descending?e.points-t.points:t.points-e.points},e.prototype.getRankStatesHeaderString=function(){return s.sprintf("%-30s | %-14s | %-5s | %-5s | %-5s | %8s | %-8s".underline,"Name","ID","W","T","L","Points","Matches")},e.prototype.getRankStateString=function(t,e,n){return s.sprintf("%-30s".blue+" | %-14s | %-5s | %-5s | %-5s | "+"%-8s".green+" | %-8s",t.tournamentID.name,t.tournamentID.id,e.wins,e.ties,e.losses,e.points,n)},e}(u.RankSystem);e.WinsSystem=l},8147:function(t,e,n){"use strict";var r=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e};Object.defineProperty(e,"__esModule",{value:!0});var i=function(){};e.RankSystem=i;var s=r(n(3338)),o=r(n(6063)),a=r(n(9484));!function(t){t.TrueSkillSystem=s.TrueSkillSystem,t.ELOSystem=o.ELOSystem,t.WinsSystem=a.WinsSystem}(i=e.RankSystem||(e.RankSystem={})),e.RankSystem=i},1170:function(t,e,n){"use strict";var r=this&&this.__spreadArrays||function(){for(var t=0,e=0,n=arguments.length;e<n;e++)t+=arguments[e].length;var r=Array(t),i=0;for(e=0;e<n;e++)for(var s=arguments[e],o=0,a=s.length;o<a;o++,i++)r[i]=s[o];return r},i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});var s=i(n(2904)),o=n(3739),a=function(){function t(){}return t.Random=function(t){void 0===t&&(t={agentsPerMatch:[2]});var e=s.default(t.seed);return function(n){var r=n;!0!==t.allowDisabled&&(r=n.filter((function(t){return!t.player.disabled})));var i=[];if(!1!==t.scheduleEvenly)for(var s=function(n){var s=t.agentsPerMatch[Math.floor(e()*t.agentsPerMatch.length)],a=o.chooseKRandomElements(r.filter((function(t,e){return e!=n})),s-1).map((function(t){return t.player.tournamentID.id}));a.push(r[n].player.tournamentID.id),i.push(a)},a=0;a<r.length;a++)s(a);else{var u=t.agentsPerMatch[Math.floor(e()*t.agentsPerMatch.length)],c=o.chooseKRandomElements(r,u).map((function(t){return t.player.tournamentID.id}));i.push(c)}return i}},t.RankRangeRandom=function(t){var e=this;void 0===t&&(t={agentsPerMatch:[2],range:4,seed:0});var n=s.default(t.seed);return function(r){var i=r;!0!==t.allowDisabled&&(i=r.filter((function(t){return!t.player.disabled})));var s=[];if(!1!==t.scheduleEvenly)for(var o=0;o<i.length;o++)s.push(e._GenerateRankRangeRandom(t,n,i,o));else s.push(e._GenerateRankRangeRandom(t,n,i,Math.floor(Math.random()*i.length)));return s}},t._GenerateRankRangeRandom=function(t,e,n,i){var s=t.agentsPerMatch[Math.floor(e()*t.agentsPerMatch.length)],a=i-t.range,u=i+t.range+1;a<0?(u+=0-a,a=0):u>n.length&&(a-=Math.max(0,u-n.length),a=Math.max(a,0));var c=o.chooseKRandomElements(r(n.slice(a,i),n.slice(i+1,u)),s-1).map((function(t){return t.player.tournamentID.id}));return c.push(n[i].player.tournamentID.id),c},t.TrueskillVarianceWeighted=function(t){var e=this;void 0===t&&(t={agentsPerMatch:[2],matchCount:10,seed:0,range:5});var n=s.default(t.seed);return function(r){var i=r;if(0===i.length)return[];!0!==t.allowDisabled&&(i=r.filter((function(t){return!t.player.disabled})));var s=[],o=[],a=0;i.forEach((function(t,e){var n=t.rankState;0==e?s.push(n.rating.sigma):s.push(s[s.length-1]+n.rating.sigma),a+=n.rating.sigma}));for(var u=[],c=0;c<t.matchCount;c++){for(var l=n()*a,h=0,f=s.length-1;h<f;){var d=Math.floor((h+f)/2);s[d]<l?h=d+1:s[d]>=l&&(f=d)}u.push(f)}return u.forEach((function(r){o.push(e._GenerateRankRangeRandom(t,n,i,r))})),o}},t}();e.Scheduler=a},3739:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.chooseKRandomElements=function(t,e){for(var n=[],r=0;r<e;r++)n.push(t[r]);for(r=e;r<t.length;r++){var i=Math.round(Math.random()*r);i<e&&(n[i]=t[r])}return n}},7422:(t,e)=>{"use strict";var n;Object.defineProperty(e,"__esModule",{value:!0}),(n=e.TournamentStatus||(e.TournamentStatus={})).UNINITIALIZED="uninitialized",n.INITIALIZED="initialized",n.STOPPED="stopped",n.RUNNING="running",n.CRASHED="crashed",n.FINISHED="finished"},3549:(t,e)=>{"use strict";var n;Object.defineProperty(e,"__esModule",{value:!0}),(n=e.TournamentType||(e.TournamentType={})).ELIMINATION="elimination",n.LADDER="ladder",n.UNKNOWN="unknown_tournament_type"},5318:function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),s=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},o=this&&this.__generator||function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},a=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});var u=n(8614),c=n(578),l=n(7792),h=n(8579),f=n(8147),d=n(8234),p=n(6046),m=n(5660),g=a(n(22)),y=n(7422),v=n(3549),_=function(){function t(t,e,n,r){this.tournamentID=t,this.file=e,this.anonymous=!0,this.username=void 0,this.botDirPath=void 0,this.botkey=void 0,this.disabled=!1,this.zipFile=void 0,this.version=0,this.botkey=r,this.zipFile=n}return t.generatePlayerID=function(){return p.genID(12)},t}();e.Player=_;var b=function(t){function e(n,r,i,s){var o=t.call(this)||this;return o.design=n,o.matches=new Map,o.matchQueue=[],o.status=e.Status.UNINITIALIZED,o.log=new h.Logger,o.competitors=new Map,o.anonymousCompetitors=new Map,o.name="",o.initialAddPlayerPromises=[],o.lockedPlayers=new Map,o.lastVersionUsed=new Map,o.id=r,i.id&&(o.id=i.id),o.log.level=void 0!==i.loggingLevel?i.loggingLevel:h.Logger.LEVEL.INFO,o.name=i.name?i.name:"tournament_"+o.id,o.log.identifier=o.name,o.dimension=s,o.log.info("Created Tournament - ID: "+o.id+", Name: "+o.name),!i.name&&s.hasDatabase()&&o.log.error("A name has to be specified for a tournament otherwise tournament player data will not be reused across runs of the tournament"),o}return i(e,t),e.prototype.addplayer=function(t,e,n){return void 0===n&&(n=!1),s(this,void 0,void 0,(function(){var r,i,s,a,u,c,l,h,f;return o(this,(function(o){switch(o.label){case 0:return"string"!=typeof t&&(e||(e=t.existingID)),e?[4,this.getPlayerStat(e)]:[3,11];case 1:return(i=o.sent().playerStat)?(s=this.lockedPlayers.get(e))?[4,s.lockvar()]:[3,3]:[3,9];case 2:return o.sent(),[3,4];case 3:s=new g.default,this.lockedPlayers.set(e,s),o.label=4;case 4:(a=i.player).disabled=!1,u=a.tournamentID.name,c=a.file,a.botDirPath&&m.removeDirectorySync(a.botDirPath),"string"==typeof t?a.file=t:(a.file=t.file,a.tournamentID.name=t.name,a.botDirPath=t.botdir,a.zipFile=t.zipFile,a.botkey=t.botkey,n||a.version++),o.label=5;case 5:return o.trys.push([5,7,,8]),[4,this.updatePlayer(a,u,c)];case 6:return o.sent(),s.unlock(),this.lockedPlayers.delete(e),[3,8];case 7:throw l=o.sent(),s.unlockWithError(l),this.lockedPlayers.delete(e),l;case 8:return r=e,[2,a];case 9:r=e,o.label=10;case 10:return[3,12];case 11:r=this.generateNextTournamentIDString(),o.label=12;case 12:return"string"!=typeof t?[3,17]:(h=new _({id:r,name:"player-"+r,username:void 0},t,void 0),this.dimension.hasDatabase()?[4,this.dimension.databasePlugin.getUser(h.tournamentID.id)]:[3,14]);case 13:return(f=o.sent())?(h.anonymous=!1,h.username=f.username,h.tournamentID.username=f.username):this.competitors.set(r,h),[3,15];case 14:this.competitors.set(r,h),o.label=15;case 15:return h.anonymous&&this.anonymousCompetitors.set(r,h),[4,this.internalAddPlayer(h)];case 16:return o.sent(),[2,h];case 17:return(h=new _({id:r,name:t.name,username:void 0},t.file,t.zipFile,t.botkey)).botDirPath=t.botdir,this.dimension.hasDatabase()?[4,this.dimension.databasePlugin.getUser(h.tournamentID.id)]:[3,19];case 18:return(f=o.sent())?(h.tournamentID.name=t.name,h.anonymous=!1,h.username=f.username,h.tournamentID.username=f.username):this.competitors.set(r,h),[3,20];case 19:this.competitors.set(r,h),o.label=20;case 20:return h.anonymous&&this.anonymousCompetitors.set(r,h),[4,this.internalAddPlayer(h)];case 21:return o.sent(),[2,h]}}))}))},e.prototype.generateNextTournamentIDString=function(){return _.generatePlayerID()},e.prototype.disablePlayer=function(t){return s(this,void 0,void 0,(function(){var e,n,r;return o(this,(function(i){switch(i.label){case 0:return[4,this.getPlayerStat(t)];case 1:return e=i.sent(),n=e.user,(r=e.playerStat)?(r.player.disabled=!0,this.dimension.hasDatabase()&&n?[4,this.dimension.databasePlugin.updateUser(t,n)]:[3,3]):[3,4];case 2:i.sent(),i.label=3;case 3:return[3,5];case 4:throw new l.TournamentPlayerDoesNotExistError("Player "+t+" was not found in this tournament");case 5:return[2]}}))}))},e.prototype.removePlayer=function(t){return s(this,void 0,void 0,(function(){var e,n,r;return o(this,(function(i){switch(i.label){case 0:return[4,this.getPlayerStat(t)];case 1:return e=i.sent(),n=e.user,(r=e.playerStat)?(this.competitors.delete(t),this.anonymousCompetitors.delete(t),r.player.disabled=!0,this.dimension.hasDatabase()&&n?[4,this.dimension.databasePlugin.updateUser(t,n)]:[3,3]):[3,5];case 2:i.sent(),i.label=3;case 3:return[4,this.internalRemovePlayer(t)];case 4:return i.sent(),[3,6];case 5:throw new l.TournamentPlayerDoesNotExistError("Not a player");case 6:return[2]}}))}))},e.prototype.internalRemovePlayer=function(t){return s(this,void 0,void 0,(function(){return o(this,(function(t){return[2]}))}))},e.prototype.runMatch=function(t){return s(this,void 0,void 0,(function(){var n,r,i,a,u,h,f,p,m,y,v,_,b,w=this;return o(this,(function(S){switch(S.label){case 0:if(!t.length)throw new l.FatalError("No players provided for match");n=[],t.forEach((function(t){w.lockedPlayers.has(t.tournamentID.id)&&n.push(w.lockedPlayers.get(t.tournamentID.id).lock)})),r=d.deepCopy(this.getConfigs().defaultMatchConfigs),i=[],a=0,u=t,S.label=1;case 1:return a<u.length?(h=u[a],[4,this.getLastVersionUsedOfPlayer(h.tournamentID.id)]):[3,4];case 2:void 0!==(f=S.sent())&&f===h.version?(this.log.system("player "+h.tournamentID.id+" attempting to use cached bot"),i.push({useCachedBotFile:!0})):(this.log.system("player "+h.tournamentID.id+" not using cached bot file"),i.push({useCachedBotFile:!1})),S.label=3;case 3:return a++,[3,1];case 4:r.agentSpecificOptions=i,p=t.map((function(t){return{file:t.file,tournamentID:t.tournamentID,botkey:t.botkey,version:t.version}})),m=new c.Match(this.design,p,r,this.dimension),this.matches.set(m.id,m),S.label=5;case 5:return S.trys.push([5,14,15,16]),[4,Promise.all(n)];case 6:S.sent(),y=0,S.label=7;case 7:return y<t.length?(v=this.lockedPlayers.get(t[y].tournamentID.id))?[4,v.lockvar()]:[3,9]:[3,11];case 8:return S.sent(),[3,10];case 9:this.lockedPlayers.set(t[y].tournamentID.id,new g.default),S.label=10;case 10:return y++,[3,7];case 11:return[4,m.initialize().finally((function(){for(var e=0;e<t.length;e++){var n=w.lockedPlayers.get(t[e].tournamentID.id);n&&(n.unlock(),w.lockedPlayers.delete(t[e].tournamentID.id))}}))];case 12:return S.sent(),t.forEach((function(t){return s(w,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return[4,this.updateLastVersionUsedOfPlayer(t.tournamentID.id,t.version)];case 1:return e.sent(),[2]}}))}))})),[4,m.run()];case 13:return _=S.sent(),this.matches.delete(m.id),[2,{results:_,match:m}];case 14:return b=S.sent(),this.emit(e.Events.MATCH_RAN),[2,{results:!1,err:b,match:m}];case 15:return this.dimension.hasDatabase()&&this.dimension.databasePlugin.configs.saveTournamentMatches&&this.dimension.databasePlugin.storeMatch(m,this.id),[7];case 16:return[2]}}))}))},e.prototype.getMatchInfoFromQueuedMatch=function(t){return s(this,void 0,void 0,(function(){var e,n,r;return o(this,(function(i){switch(i.label){case 0:for(e=[],n=0;n<t.length;n++)r=t[n],e.push(this.getPlayerStat(r).then((function(t){return t.playerStat.player})));return[4,Promise.all(e)];case 1:return[2,i.sent()]}}))}))},e.prototype.getLastVersionUsedOfPlayer=function(t){return s(this,void 0,void 0,(function(){return o(this,(function(e){return[2,Promise.resolve(this.lastVersionUsed.get(t))]}))}))},e.prototype.updateLastVersionUsedOfPlayer=function(t,e){return s(this,void 0,void 0,(function(){return o(this,(function(n){return this.lastVersionUsed.set(t,e),[2]}))}))},e.prototype.removeMatch=function(t){return s(this,void 0,void 0,(function(){return o(this,(function(e){switch(e.label){case 0:return this.matches.has(t)?[4,this.matches.get(t).destroy()]:[3,2];case 1:return e.sent(),[2,this.matches.delete(t)];case 2:return[2,!1]}}))}))},e.prototype.destroy=function(){return s(this,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,this.preInternalDestroy()];case 1:return n.sent(),this.status===e.Status.RUNNING&&this.stop(),t=[],this.matches.forEach((function(e){t.push(e.destroy())})),[4,Promise.all(t)];case 2:return n.sent(),[4,this.postInternalDestroy()];case 3:return n.sent(),[2]}}))}))},e.prototype.preInternalDestroy=function(){return s(this,void 0,void 0,(function(){return o(this,(function(t){return[2]}))}))},e.prototype.postInternalDestroy=function(){return s(this,void 0,void 0,(function(){return o(this,(function(t){return[2]}))}))},e.genTournamentClassID=function(){return p.genID(6)},e.prototype.getSafeName=function(){return this.name.replace(/ /g,"_")},e.prototype.getKeyName=function(){return this.getSafeName()+"_"+this.id},e.prototype.getPlayerStat=function(t){return s(this,void 0,void 0,(function(){var e,n;return o(this,(function(r){switch(r.label){case 0:if(this.state.playerStats.has(t))return[3,6];if(!this.dimension.hasDatabase())return[3,5];e=void 0,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.dimension.databasePlugin.getUser(t)];case 2:return e=r.sent(),[3,4];case 3:throw n=r.sent(),this.log.error(n),new l.DatabaseGetUserError("failed to get database user with id: "+t);case 4:if(e&&e.statistics[this.getKeyName()])return[2,{user:e,playerStat:e.statistics[this.getKeyName()]}];r.label=5;case 5:return[3,7];case 6:return[2,{user:null,playerStat:this.state.playerStats.get(t)}];case 7:return[2,{user:null,playerStat:null}]}}))}))},e}(u.EventEmitter);e.Tournament=b;var w=n(3872),S=n(4057),E=n(1170);!function(t){var e,n;t.Ladder=w.Ladder,t.Elimination=S.Elimination,t.Scheduler=E.Scheduler,t.Type=v.TournamentType,t.Status=y.TournamentStatus,t.RankSystem=f.RankSystem,(n=t.Events||(t.Events={})).INITIAL_PLAYERS_INITIALIZED="initial_players_initialized",n.MATCH_RAN="match_ran",n.MATCH_HANDLED="match_handled",(e=t.RankSystemTypes||(t.RankSystemTypes={})).WINS="wins",e.ELO="elo",e.TRUESKILL="trueskill"}(b=e.Tournament||(e.Tournament={})),e.Tournament=b},2880:(t,e,n)=>{"use strict";function r(t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n])}Object.defineProperty(e,"__esModule",{value:!0}),r(n(1850));var i=n(8389);e.create=i.create,e.DimensionType=i.Dimension,e.DatabaseType=i.DatabaseType,r(n(3892)),r(n(8579)),r(n(2602)),r(n(2605)),r(n(5318)),r(n(578)),r(n(1182)),r(n(9418));var s=n(7792);e.MatchError=s.MatchError,e.FatalError=s.FatalError,e.MatchWarn=s.MatchWarn},8234:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.deepCopy=function t(e){var n;if(null==e||"object"!=typeof e)return e;if(e instanceof Date)return(n=new Date).setTime(e.getTime()),n;if(e instanceof Array){n=[];for(var r=0,i=e.length;r<i;r++)n[r]=t(e[r]);return n}if(e instanceof Object){for(var s in n={},e)e.hasOwnProperty(s)&&(n[s]=t(e[s]));return n}throw new Error("Unable to copy obj! Its type isn't supported.")}},2943:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.deepMerge=function(t,n,r){return void 0===r&&(r=!1),null==n||null==n||Object.keys(n).forEach((function(i){var s;"object"!=typeof n[i]&&n[i]&&"Array"!==n[i].constructor.name?t[i]=n[i]:n[i]&&"Array"==n[i].constructor.name&&t[i]&&"Array"==t[i].constructor.name?r?t[i]=n[i]:(s=t[i]).push.apply(s,n[i]):t[i]&&"object"==typeof t[i]?t[i]=e.deepMerge(t[i],n[i],r):t[i]=n[i]})),t}},5660:function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},i=this&&this.__generator||function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}},s=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)Object.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e.default=t,e},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});var a=n(3129),u=s(n(5747)),c=o(n(5622));e.LOCAL_DIR=c.default.join(__dirname,"../../../../../local"),e.removeFileSync=function(t){a.spawnSync("rm",["-f",t])},e.removeFile=function(t){return new Promise((function(e,n){var r=a.spawn("rm",["-f",t]);r.on("error",(function(t){n(t)})),r.on("close",(function(t){0===t?e():n("exited with code "+t)}))}))},e.processIsRunning=function(t){try{return process.kill(t,0)}catch(t){return"EPERM"===t.code}},e.removeDirectorySync=function(t){a.spawnSync("find",[t,"-exec","rm","-rf","{}","+"])},e.removeDirectory=function(t){return new Promise((function(e,n){var r=a.spawn("find",[t,"-exec","rm","-rf","{}","+"]);r.on("error",(function(t){n(t)})),r.on("close",(function(r){0===r?e():n("removeDirectory on "+t+" exited with code "+r)}))}))},e.writeFileToDestination=function(t,e){return r(void 0,void 0,void 0,(function(){return i(this,(function(n){return[2,new Promise((function(n){u.default.existsSync(c.default.dirname(e))||u.mkdirSync(c.default.dirname(e),{recursive:!0}),u.default.createReadStream(t).pipe(u.default.createWriteStream(e)).on("close",(function(){n()}))}))]}))}))},e.dockerCopy=function(t,e,n){return new Promise((function(r,i){var s=a.spawn("docker",["cp",t,e+":"+n]);s.on("error",(function(t){i(t)})),s.on("close",(function(s){0===s?r():i("dockerCopy from "+t+" to "+e+":"+n+" exited with code "+s)}))}))}},1861:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.isChildProcess=function(t){return!!t&&"ChildProcess"===t.constructor.name};var n=function(){function t(){}return t.isGenerationMetaData_FilesOnly=function(t){return"string"==typeof t[0]},t.isGenerationMetaData_CreateMatch=function(t){return void 0!==t[0].name},t.isGenerationMetaData_Tournament=function(t){return void 0!==t[0].tournamentID},t}();e.AgentClassTypeGuards=n},22:function(t,e){"use strict";var n=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},r=this&&this.__generator||function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(){this.lockvar()}return t.prototype.lockvar=function(){return n(this,void 0,void 0,(function(){var t=this;return r(this,(function(e){switch(e.label){case 0:return this.lock?[4,this.lock]:[3,2];case 1:e.sent(),e.label=2;case 2:return this.lock=new Promise((function(e,n){t.promiseRes=e,t.rejectRes=n})),[2]}}))}))},t.prototype.unlock=function(t){this.promiseRes(t)},t.prototype.unlockWithError=function(t){this.rejectRes(t)},t}();e.default=i},6046:function(t,e,n){"use strict";var r=this&&this.__awaiter||function(t,e,n,r){return new(n||(n=Promise))((function(i,s){function o(t){try{u(r.next(t))}catch(t){s(t)}}function a(t){try{u(r.throw(t))}catch(t){s(t)}}function u(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,a)}u((r=r.apply(t,e||[])).next())}))},i=this&&this.__generator||function(t,e){var n,r,i,s,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return s={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function a(s){return function(a){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,r=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=e.call(t,o)}catch(t){s=[6,t],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,a])}}};Object.defineProperty(e,"__esModule",{value:!0});var s=n(3169);e.pick=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];var r={};return e.forEach((function(e){r[e]=t[e]})),r};for(var o=new Map,a=4;a<=22;a++)o.set(a,s.customAlphabet("0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",a));e.genID=function(t){return o.get(t)()},e.stripFunctions=function(t){var e=new Set,n=function(t){for(var r in t)if(!e.has(r)){if(e.add(r),"function"==typeof t[r]){delete t[r];continue}if(null!==t[r]&&void 0!==t[r]&&"Array"===t[r].constructor.name)continue;n(t[r])}return t};return n(t)},e.stripNull=function(t){var e=new Set,n=function(t){for(var r in t)e.has(r)||(e.add(r),null===t[r]?delete t[r]:n(t[r]));return t};return n(t)},e.sleep=function(t){return r(void 0,void 0,void 0,(function(){return i(this,(function(e){return[2,new Promise((function(e){setTimeout((function(){e()}),t)}))]}))}))},e.noop=function(){}},7260:t=>{function e(t){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}e.keys=()=>[],e.resolve=e,e.id=7260,t.exports=e},3618:t=>{function e(t){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}e.keys=()=>[],e.resolve=e,e.id=3618,t.exports=e},9682:(t,e,n)=>{var r={"./bin":8204,"./bin.js":8204,"./helpers/cpu":6640,"./helpers/cpu.js":6640,"./helpers/parallel":9653,"./helpers/parallel.js":9653,"./history":246,"./history.js":246,"./procfile":8041,"./procfile.js":8041,"./ps":97,"./ps.js":97,"./stats":271,"./stats.js":271,"./wmic":5225,"./wmic.js":5225};function i(t){var e=s(t);return n(e)}function s(t){if(!n.o(r,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return r[t]}i.keys=function(){return Object.keys(r)},i.resolve=s,t.exports=i,i.id=9682},2357:t=>{"use strict";t.exports=require("assert")},4293:t=>{"use strict";t.exports=require("buffer")},3129:t=>{"use strict";t.exports=require("child_process")},7619:t=>{"use strict";t.exports=require("constants")},6417:t=>{"use strict";t.exports=require("crypto")},881:t=>{"use strict";t.exports=require("dns")},8614:t=>{"use strict";t.exports=require("events")},5747:t=>{"use strict";t.exports=require("fs")},8605:t=>{"use strict";t.exports=require("http")},7211:t=>{"use strict";t.exports=require("https")},1631:t=>{"use strict";t.exports=require("net")},2087:t=>{"use strict";t.exports=require("os")},5622:t=>{"use strict";t.exports=require("path")},1191:t=>{"use strict";t.exports=require("querystring")},1058:t=>{"use strict";t.exports=require("readline")},2413:t=>{"use strict";t.exports=require("stream")},4304:t=>{"use strict";t.exports=require("string_decoder")},3867:t=>{"use strict";t.exports=require("tty")},8835:t=>{"use strict";t.exports=require("url")},1669:t=>{"use strict";t.exports=require("util")},8761:t=>{"use strict";t.exports=require("zlib")}},i={};function s(t){var e=i[t];if(void 0!==e)return e.exports;var n=i[t]={id:t,loaded:!1,exports:{}};return r[t].call(n.exports,n,n.exports,s),n.loaded=!0,n.exports}s.m=r,s.x=()=>{var t=s.O(void 0,[396],(()=>s(2791)));return s.O(t)},s.amdD=function(){throw new Error("define cannot be used indirect")},s.amdO={},t=[],s.O=(e,n,r,i)=>{if(!n){var o=1/0;for(c=0;c<t.length;c++){for(var[n,r,i]=t[c],a=!0,u=0;u<n.length;u++)(!1&i||o>=i)&&Object.keys(s.O).every((t=>s.O[t](n[u])))?n.splice(u--,1):(a=!1,i<o&&(o=i));a&&(t.splice(c--,1),e=r())}return e}i=i||0;for(var c=t.length;c>0&&t[c-1][2]>i;c--)t[c]=t[c-1];t[c]=[n,r,i]},s.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return s.d(e,{a:e}),e},s.d=(t,e)=>{for(var n in e)s.o(e,n)&&!s.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},s.f={},s.e=t=>Promise.all(Object.keys(s.f).reduce(((e,n)=>(s.f[n](t,e),e)),[])),s.u=t=>t+".js",s.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),s.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.nmd=t=>(t.paths=[],t.children||(t.children=[]),t),n={179:1},s.O.require=t=>n[t],s.f.require=(t,e)=>{n[t]||(t=>{var e=t.modules,r=t.ids,i=t.runtime;for(var o in e)s.o(e,o)&&(s.m[o]=e[o]);i&&i(s);for(var a=0;a<r.length;a++)n[r[a]]=1;s.O()})(require("./"+s.u(t)))},e=s.x,s.x=()=>(s.e(396),e()),s.x()})();